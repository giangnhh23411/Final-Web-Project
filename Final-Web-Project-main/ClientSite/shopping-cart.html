<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Phuc Long</title>
    <link rel="stylesheet" href="/Assets/Components/header-footer.css">
    <link rel="stylesheet" href="/Assets/CSS/shopping-cart.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Alata:wght@400&display=swap" rel="stylesheet">
    <style>
        /* Voucher Dropdown Styles */
        .voucher-dropdown summary {
            list-style: none;
        }
        .voucher-dropdown summary::-webkit-details-marker {
            display: none;
        }
        .voucher-dropdown summary::marker {
            display: none;
        }
        /* Ch·ªâ rotate m≈©i t√™n, kh√¥ng rotate to√†n b·ªô summary */
        .voucher-dropdown[open] summary .arrow-icon {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }
        .voucher-dropdown summary .arrow-icon {
            transition: transform 0.3s;
            display: inline-block;
        }
        /* Product Voucher Dropdown Styles */
        .product-voucher-dropdown summary {
            list-style: none;
        }
        .product-voucher-dropdown summary::-webkit-details-marker {
            display: none;
        }
        .product-voucher-dropdown summary::marker {
            display: none;
        }
        .product-voucher-dropdown[open] summary .arrow-icon {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }
        .product-voucher-dropdown summary .arrow-icon {
            transition: transform 0.3s;
            display: inline-block;
        }
        /* Scrollbar styling cho voucher list */
        .product-voucher-list::-webkit-scrollbar {
            width: 6px;
        }
        .product-voucher-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .product-voucher-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .product-voucher-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section - Dynamic -->
        <div id="site-header"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="cart-container">
                <!-- Left Column - Product List -->
                <div class="cart-left">
                    <div class="cart-table">
                        <div class="table-header">
                            <div class="col-checkbox">
                                <input type="checkbox" id="selectAll" class="select-all-checkbox">
                            </div>
                            <div class="col-product">Product</div>
                            <div class="col-price">Price</div>
                            <div class="col-quantity">Quantity</div>
                            <div class="col-total">Total</div>
                            <div class="col-action">Action</div>
                        </div>
                        
                        <!-- Product Items - Dynamic Content -->
                        <div class="product-list" id="productList">
                            <!-- Cart items will be loaded here dynamically -->
                        </div>
                    </div>
                    
                    <div class="cart-actions">
                        <button class="update-cart-btn" onclick="loadCartData()">Update Cart</button>
                        <button class="clear-cart-btn" onclick="clearCart()">Clear Cart</button>
                    </div>
                </div>

                <!-- Right Column - Cart Summary -->
                <div class="cart-right">
                    <div class="cart-summary">
                        <h3>Cart Totals</h3>
                        <div class="summary-row">
                            <span>Subtotals:</span>
                            <span id="subtotal">‚Ç´0</span>
                        </div>
                        
                        <!-- Voucher Section - Badge hi·ªÉn th·ªã voucher ƒë√£ √°p d·ª•ng -->
                        <div id="voucher-applied-badge" style="display: none; margin: 20px 0; padding: 10px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: normal;">
                            üéüÔ∏è ƒê√£ √°p d·ª•ng voucher: <span id="applied-voucher-code-display"></span>
                            <button onclick="removeVoucher()" style="
                                margin-left: 8px;
                                background: rgba(255,255,255,0.3);
                                color: white;
                                border: 1px solid white;
                                padding: 2px 6px;
                                border-radius: 3px;
                                cursor: pointer;
                                font-size: 11px;
                            ">‚úï</button>
                        </div>
                        
                        <!-- Voucher Section - Dropdown -->
                        <details class="voucher-dropdown" id="voucher-dropdown" style="margin: 20px 0; display: none;">
                            <summary style="
                                padding: 12px 16px;
                                background: #f8f9fa;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                color: #333;
                                list-style: none;
                                user-select: none;
                            ">
                                <span style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>üéüÔ∏è Voucher kh·∫£ d·ª•ng (<span id="voucher-count">0</span>)</span>
                                    <span class="arrow-icon" style="font-size: 12px; color: #666;">‚ñº</span>
                                </span>
                            </summary>
                            <div id="voucher-list" style="
                                margin-top: 10px;
                                padding: 15px;
                                background: white;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                display: flex;
                                flex-direction: column;
                                gap: 8px;
                                max-height: 300px;
                                overflow-y: auto;
                            ">
                                <!-- Vouchers will be loaded here -->
                            </div>
                        </details>
                        
                        <div class="summary-row" id="discount-row" style="display: none; color: #28a745;">
                            <span>Gi·∫£m gi√°:</span>
                            <span id="discount-amount">-‚Ç´0</span>
                        </div>
                        <div class="summary-row">
                            <span>Totals:</span>
                            <span id="total">‚Ç´0</span>
                        </div>
                        <div class="shipping-info">
                            <span class="checkmark">‚úì</span>
                            <span>Shipping & taxes calculated at checkout</span>
                        </div>
                        <button class="checkout-btn" id="checkout-btn" onclick="handleCheckout()">Proceed To Checkout</button>
                        <div class="calculate-shipping">
                            <h4>Calculate Shopping</h4>
                        </div>
                    </div>

                    <!-- Chat Icon -->
                    <div class="chat-icon-container">
                        <div class="chat-icon-btn" onclick="toggleChat()">
                            <span class="chat-icon">üí¨</span>
                            <span class="notification-dot">1</span>
                        </div>
                    </div>

                    <!-- Chat Widget (Hidden by default) -->
                    <div class="chat-widget" id="chatWidget" style="display: none;">
                        <div class="chat-header">
                            <h4>Chat</h4>
                            <button class="close-chat-btn" onclick="toggleChat()">√ó</button>
                        </div>
                        <div class="chat-content">
                            <div class="chat-sidebar">
                                <div class="pinned-conversations">
                                    <h5>üìå Pinned Conversations</h5>
                                    <div class="conversation-item">
                                        <span>Jane Carr</span>
                                        <span class="notification">1</span>
                                    </div>
                                    <div class="conversation-item">
                                        <span>Angel Lubin</span>
                                    </div>
                                    <div class="conversation-item">
                                        <span>Kaiya Levin</span>
                                        <span class="notification">1</span>
                                    </div>
                                    <div class="conversation-item">
                                        <span>Phillip Aminoff</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-main">
                                <div class="chat-message">
                                    <div class="message-bubble">Hey!</div>
                                </div>
                                <div class="chat-input">
                                    <button class="attach-btn">+</button>
                                    <input type="text" placeholder="Message">
                                    <button class="mic-btn">üé§</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Section - Dynamic -->
        <div id="site-footer"></div>
    </div>

    <script>
        function toggleChat() {
            const chatWidget = document.getElementById('chatWidget');
            if (chatWidget.style.display === 'none') {
                chatWidget.style.display = 'block';
            } else {
                chatWidget.style.display = 'none';
            }
        }

        // Close chat when clicking outside
        document.addEventListener('click', function(event) {
            const chatWidget = document.getElementById('chatWidget');
            const chatIconBtn = document.querySelector('.chat-icon-btn');
            
            if (!chatWidget.contains(event.target) && !chatIconBtn.contains(event.target)) {
                chatWidget.style.display = 'none';
            }
        });

        // Load cart data from localStorage when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any existing sample data first
            clearSampleData();
            // Then load real cart data
            loadCartData();
        });

        function clearSampleData() {
            // Remove any hardcoded sample data
            const productContainer = document.querySelector('#productList');
            if (productContainer) {
                productContainer.innerHTML = '';
            }
        }
    </script>
    <!-- Load shared header and footer - MUST be loaded first -->
    <script src="/Assets/Components/layout.js" defer></script>
    <script src="../Assets/JS/cart-manager.js"></script>
    <script>
        // L·∫•y user_id v√† session_id
        function getCartIdentifiers() {
            const currentUser = JSON.parse(localStorage.getItem('phuclong_current_user') || 'null');
            const sessionId = localStorage.getItem('phuclong_session_id') || null;
            
            return {
                user_id: currentUser ? (currentUser.id || currentUser._id) : null,
                session_id: sessionId
            };
        }
        
        // Fetch cart t·ª´ API
        async function fetchCartFromAPI() {
            try {
                const { user_id, session_id } = getCartIdentifiers();
                let apiUrl = '/api/carts?';
                
                if (user_id) {
                    apiUrl += `user_id=${encodeURIComponent(user_id)}`;
                } else if (session_id) {
                    apiUrl += `session_id=${encodeURIComponent(session_id)}`;
                }
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.data) {
                    // L∆∞u session_id n·∫øu c√≥
                    if (result.data.session_id && !session_id) {
                        localStorage.setItem('phuclong_session_id', result.data.session_id);
                    }
                    
                    return result.data.items || [];
                }
                
                return [];
            } catch (error) {
                console.error('Error fetching cart:', error);
                // Fallback: d√πng LocalStorage
                return JSON.parse(localStorage.getItem('phuclong_cart') || '[]');
            }
        }
        
        async function loadCartData() {
            console.log('Loading cart data from API...');
            const productContainer = document.querySelector('#productList');
            
            if (!productContainer) {
                console.error('Product container not found!');
                return;
            }
            
            // Fetch cart t·ª´ API
            cartItems = await fetchCartFromAPI();
            console.log('Cart items from API:', cartItems);
            
            // C·∫≠p nh·∫≠t LocalStorage ƒë·ªÉ sync
            const localCart = cartItems.map(item => ({
                id: item.product_id || item.id,
                name: item.name,
                price: item.price,
                image: item.image || '',
                quantity: item.quantity || 1
            }));
            localStorage.setItem('phuclong_cart', JSON.stringify(localCart));
            
            if (cartItems.length === 0) {
                productContainer.innerHTML = `
                    <div class="empty-cart" style="
                        text-align: center;
                        padding: 60px 20px;
                        background-color: #f8f9fa;
                        border-radius: 8px;
                        margin: 20px 0;
                    ">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 24px;">Gi·ªè h√†ng tr·ªëng</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 16px;">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng.</p>
                        <a href="/" style="
                            background-color: #fb2e86;
                            color: white;
                            padding: 12px 24px;
                            text-decoration: none;
                            border-radius: 4px;
                            font-weight: 600;
                            display: inline-block;
                        ">Ti·∫øp t·ª•c mua s·∫Øm</a>
                    </div>
                `;
                updateCartSummaryWithVoucher([]);
                
                // Load vouchers ngay c·∫£ khi cart tr·ªëng
                setTimeout(() => {
                    loadVouchers();
                }, 300);
                
                return;
            }

            let html = '';
            cartItems.forEach((item, index) => {
                const productId = item.product_id || item.id;
                const imagePath = item.image || '';
                
                // X·ª≠ l√Ω image path: n·∫øu ƒë√£ l√† full URL (http/https) th√¨ d√πng tr·ª±c ti·∫øp
                let imageSrc = '';
                if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                    imageSrc = imagePath;
                } else if (imagePath.startsWith('/')) {
                    imageSrc = imagePath;
                } else if (imagePath) {
                    imageSrc = `/Assets/images/${imagePath}`;
                } else {
                    imageSrc = '/Assets/images/LogoPhucLong.png'; // Default image
                }
                
                html += `
                    <div class="product-item" data-product-id="${productId}">
                        <div class="product-checkbox">
                            <input type="checkbox" class="product-checkbox-input" checked data-product-id="${productId}">
                        </div>
                        <div class="product-details">
                            <div class="product-image">
                                <img src="${imageSrc}" alt="${item.name}" onerror="this.src='/Assets/images/LogoPhucLong.png'">
                            </div>
                            <div class="product-info">
                                <h3>${item.name}</h3>
                                <!-- Voucher Dropdown cho t·ª´ng s·∫£n ph·∫©m -->
                                <details class="product-voucher-dropdown" data-product-id="${productId}" style="margin-top: 8px; display: none;">
                                    <summary style="
                                        padding: 10px 14px;
                                        background: #f8f9fa;
                                        border: 1px solid #ddd;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-weight: 600;
                                        font-size: 14px;
                                        color: #333;
                                        list-style: none;
                                        user-select: none;
                                    ">
                                        <span style="display: flex; align-items: center; justify-content: space-between;">
                                            <span>üéüÔ∏è Voucher kh·∫£ d·ª•ng (<span class="voucher-count-${productId}">0</span>)</span>
                                            <span class="arrow-icon" style="font-size: 12px; color: #666;">‚ñº</span>
                                        </span>
                                    </summary>
                                    <div class="product-voucher-list" data-product-id="${productId}" style="
                                        margin-top: 10px;
                                        padding: 12px;
                                        background: white;
                                        border: 1px solid #ddd;
                                        border-radius: 8px;
                                        display: flex;
                                        flex-direction: column;
                                        gap: 8px;
                                        max-height: 250px;
                                        overflow-y: auto;
                                        overflow-x: hidden;
                                    ">
                                        <!-- Vouchers will be loaded here -->
                                    </div>
                                </details>
                            </div>
                        </div>
                        <div class="product-price">‚Ç´${(item.price || 0).toLocaleString('vi-VN')}</div>
                        <div class="product-quantity">
                            <button class="qty-btn minus" onclick="updateQuantityAPI('${productId}', ${(item.quantity || 1) - 1})">-</button>
                            <input type="number" value="${item.quantity || 1}" min="1" onchange="updateQuantityAPI('${productId}', parseInt(this.value))">
                            <button class="qty-btn plus" onclick="updateQuantityAPI('${productId}', ${(item.quantity || 1) + 1})">+</button>
                        </div>
                        <div class="product-total">‚Ç´${((item.price || 0) * (item.quantity || 1)).toLocaleString('vi-VN')}</div>
                        <div class="product-actions">
                            <button class="delete-btn" onclick="removeFromCartAPI('${productId}')">Delete</button>
                        </div>
                    </div>
                `;
            });

            productContainer.innerHTML = html;
            
            // Th√™m event listeners cho checkboxes
            const checkboxes = productContainer.querySelectorAll('.product-checkbox-input');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCartSummaryFromCheckboxes);
            });
            
            updateCartSummaryFromCheckboxes();
            
            // Load vouchers cho t·ª´ng s·∫£n ph·∫©m sau khi cart ƒë√£ load xong
            setTimeout(() => {
                loadVouchersForAllProducts();
            }, 300);
            
            console.log('Cart data loaded successfully');
        }

        // Load vouchers cho t·∫•t c·∫£ s·∫£n ph·∫©m trong cart
        async function loadVouchersForAllProducts() {
            const productItems = document.querySelectorAll('.product-item');
            productItems.forEach(productItem => {
                const productId = productItem.getAttribute('data-product-id');
                if (productId) {
                    loadVouchersForProduct(productId);
                }
            });
        }
        
        // Load vouchers cho m·ªôt s·∫£n ph·∫©m c·ª• th·ªÉ
        async function loadVouchersForProduct(productId) {
            const voucherDropdown = document.querySelector(`.product-voucher-dropdown[data-product-id="${productId}"]`);
            const voucherList = document.querySelector(`.product-voucher-list[data-product-id="${productId}"]`);
            const voucherCountEl = document.querySelector(`.voucher-count-${productId}`);
            
            if (!voucherDropdown || !voucherList) {
                console.error(`Voucher elements not found for product ${productId}`);
                return;
            }
            
            try {
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ cart
                const cartItems = await fetchCartFromAPI();
                const product = cartItems.find(item => (item.product_id || item.id || item._id || item.sku) == productId);
                
                if (!product) {
                    console.log(`Product ${productId} not found in cart`);
                    voucherDropdown.style.display = 'none';
                    return;
                }
                
                const productPrice = product.price || 0;
                const productQuantity = product.quantity || 1;
                const subtotal = productPrice * productQuantity;
                
                // L·∫•y product IDs (c√≥ th·ªÉ l√† _id, product_id, id, ho·∫∑c sku)
                const productIds = [
                    String(product._id || ''),
                    String(product.product_id || ''),
                    String(product.id || ''),
                    String(product.sku || ''),
                    String(productId)
                ].filter(id => id && id !== 'undefined' && id !== 'null');
                
                console.log(`Loading vouchers for product ${productId}:`, {
                    productIds,
                    subtotal,
                    productName: product.name
                });
                
                const response = await fetch('/api/vouchers?status_q=active&pageSize=50');
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    voucherList.innerHTML = '';
                    
                    const now = new Date();
                    let hasApplicableVouchers = false;
                    let applicableCount = 0;
                    
                    result.data.forEach(voucher => {
                        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                        if (voucher.status !== 'active') return;
                        
                        // Ki·ªÉm tra th·ªùi gian
                        if (voucher.start_at) {
                            const startAt = new Date(voucher.start_at);
                            if (now < startAt) return;
                        }
                        if (voucher.end_at) {
                            const endAt = new Date(voucher.end_at);
                            if (now > endAt) return;
                        }
                        
                        // Ki·ªÉm tra applicable_product_ids
                        let productMatch = true;
                        if (voucher.applicable_product_ids && Array.isArray(voucher.applicable_product_ids) && voucher.applicable_product_ids.length > 0) {
                            const applicableIds = voucher.applicable_product_ids.map(id => String(id));
                            productMatch = productIds.some(id => applicableIds.includes(id));
                            if (!productMatch) return;
                        }
                        
                        // Ki·ªÉm tra min_order_value (√°p d·ª•ng cho subtotal c·ªßa s·∫£n ph·∫©m n√†y)
                        if (voucher.min_order_value && voucher.min_order_value > 0) {
                            if (subtotal < voucher.min_order_value) return;
                        }
                        
                        hasApplicableVouchers = true;
                        applicableCount++;
                        
                        // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng cho s·∫£n ph·∫©m n√†y
                        const appliedVoucherKey = `phuclong_selected_voucher_${productId}`;
                        const appliedVoucher = localStorage.getItem(appliedVoucherKey);
                        const isApplied = appliedVoucher && appliedVoucher === voucher.code;
                        
                        const voucherCard = document.createElement('div');
                        
                        // N·∫øu voucher ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng, d√πng n·ªÅn xanh l√°
                        if (isApplied) {
                            voucherCard.style.cssText = 'padding: 10px; background: #d4edda; border: 2px solid #28a745; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s;';
                        } else {
                            // N·ªÅn t√≠m nh·∫°t cho voucher ch∆∞a √°p d·ª•ng
                            voucherCard.style.cssText = 'padding: 10px; background: #f3e5f5; border: 1px solid #ce93d8; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s;';
                        }
                        
                        voucherCard.onmouseover = () => {
                            if (!isApplied) {
                                voucherCard.style.borderColor = '#fb2e86';
                                voucherCard.style.background = '#f8f4ff';
                            }
                        };
                        voucherCard.onmouseout = () => {
                            if (isApplied) {
                                voucherCard.style.borderColor = '#28a745';
                                voucherCard.style.background = '#d4edda';
                            } else {
                                voucherCard.style.borderColor = '#ce93d8';
                                voucherCard.style.background = '#f3e5f5';
                            }
                        };
                        
                        const discountText = voucher.type === 'percent' 
                            ? `Gi·∫£m ${voucher.value}%` 
                            : `Gi·∫£m ${formatPrice(voucher.value)}`;
                        
                        // T·∫°o elements b·∫±ng DOM
                        const cardContent = document.createElement('div');
                        cardContent.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
                        
                        const leftDiv = document.createElement('div');
                        leftDiv.style.cssText = 'flex: 1;';
                        
                        const codeStrong = document.createElement('strong');
                        codeStrong.style.cssText = `color: ${isApplied ? '#155724' : '#fb2e86'}; font-size: 14px;`;
                        codeStrong.textContent = voucher.code;
                        leftDiv.appendChild(codeStrong);
                        
                        const discountDiv = document.createElement('div');
                        discountDiv.style.cssText = 'font-size: 13px; color: #666; margin-top: 4px;';
                        discountDiv.textContent = discountText;
                        leftDiv.appendChild(discountDiv);
                        
                        // Hi·ªÉn th·ªã "ƒê√£ √°p d·ª•ng" n·∫øu voucher ƒëang ƒë∆∞·ª£c √°p d·ª•ng
                        if (isApplied) {
                            const appliedLabel = document.createElement('div');
                            appliedLabel.style.cssText = 'font-size: 12px; color: #155724; margin-top: 4px; font-weight: 600;';
                            appliedLabel.textContent = '‚úì ƒê√£ √°p d·ª•ng';
                            leftDiv.appendChild(appliedLabel);
                        }
                        
                        if (voucher.description) {
                            const descDiv = document.createElement('div');
                            descDiv.style.cssText = 'font-size: 12px; color: #999; margin-top: 2px;';
                            descDiv.textContent = voucher.description;
                            leftDiv.appendChild(descDiv);
                        }
                        
                        if (voucher.min_order_value && voucher.min_order_value > 0) {
                            const conditionDiv = document.createElement('div');
                            conditionDiv.style.cssText = 'font-size: 11px; color: #ff9800; margin-top: 2px;';
                            conditionDiv.textContent = `ƒê∆°n t·ªëi thi·ªÉu: ${formatPrice(voucher.min_order_value)}`;
                            leftDiv.appendChild(conditionDiv);
                        }
                        
                        // N·∫øu ƒë√£ √°p d·ª•ng, hi·ªÉn th·ªã n√∫t "H·ªßy √°p d·ª•ng" thay v√¨ "√Åp d·ª•ng"
                        const applyBtn = document.createElement('button');
                        if (isApplied) {
                            applyBtn.textContent = 'H·ªßy √°p d·ª•ng';
                            applyBtn.style.cssText = 'background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; margin-left: 8px;';
                            applyBtn.onclick = (e) => {
                                e.stopPropagation();
                                removeVoucherFromProduct(productId, voucher.code);
                            };
                        } else {
                            applyBtn.textContent = '√Åp d·ª•ng';
                            applyBtn.style.cssText = 'background: #fb2e86; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; margin-left: 8px;';
                            applyBtn.onclick = (e) => {
                                e.stopPropagation();
                                applyVoucherToProduct(productId, voucher.code);
                            };
                        }
                        
                        cardContent.appendChild(leftDiv);
                        cardContent.appendChild(applyBtn);
                        voucherCard.appendChild(cardContent);
                        voucherList.appendChild(voucherCard);
                    });
                    
                    // Update voucher count
                    if (voucherCountEl) voucherCountEl.textContent = applicableCount;
                    
                    // Hi·ªÉn th·ªã dropdown n·∫øu c√≥ voucher
                    if (hasApplicableVouchers) {
                        voucherDropdown.style.display = 'block';
                    } else {
                        voucherDropdown.style.display = 'none';
                    }
                    
                    if (!hasApplicableVouchers) {
                        voucherList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px; font-size: 13px;">Kh√¥ng c√≥ voucher kh·∫£ d·ª•ng cho s·∫£n ph·∫©m n√†y</div>';
                    }
                } else {
                    voucherDropdown.style.display = 'none';
                }
            } catch (error) {
                console.error(`Error loading vouchers for product ${productId}:`, error);
            }
        }
        
        // √Åp d·ª•ng voucher cho m·ªôt s·∫£n ph·∫©m
        async function applyVoucherToProduct(productId, voucherCode) {
            try {
                const response = await fetch(`/api/vouchers/${voucherCode}`);
                const result = await response.json();
                
                if (!result.code) {
                    alert('Voucher kh√¥ng t·ªìn t·∫°i!');
                    return;
                }
                
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m
                const cartItems = await fetchCartFromAPI();
                const product = cartItems.find(item => (item.product_id || item.id || item._id || item.sku) == productId);
                
                if (!product) {
                    alert('S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i!');
                    return;
                }
                
                const productPrice = product.price || 0;
                const productQuantity = product.quantity || 1;
                const subtotal = productPrice * productQuantity;
                
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                const now = new Date();
                
                if (result.status !== 'active') {
                    alert('Voucher kh√¥ng c√≤n hi·ªáu l·ª±c!');
                    return;
                }
                
                if (result.start_at) {
                    const startAt = new Date(result.start_at);
                    if (now < startAt) {
                        alert('Voucher ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c!');
                        return;
                    }
                }
                if (result.end_at) {
                    const endAt = new Date(result.end_at);
                    if (now > endAt) {
                        alert('Voucher ƒë√£ h·∫øt h·∫°n!');
                        return;
                    }
                }
                
                if (result.min_order_value && result.min_order_value > 0) {
                    if (subtotal < result.min_order_value) {
                        alert(`Voucher y√™u c·∫ßu ƒë∆°n h√†ng t·ªëi thi·ªÉu ${formatPrice(result.min_order_value)}!`);
                        return;
                    }
                }
                
                // Ki·ªÉm tra applicable_product_ids
                const productIds = [
                    String(product._id || ''),
                    String(product.product_id || ''),
                    String(product.id || ''),
                    String(product.sku || ''),
                    String(productId)
                ].filter(id => id && id !== 'undefined' && id !== 'null');
                
                if (result.applicable_product_ids && result.applicable_product_ids.length > 0) {
                    const applicableIds = result.applicable_product_ids.map(id => String(id));
                    const hasMatchingProduct = productIds.some(id => applicableIds.includes(id));
                    if (!hasMatchingProduct) {
                        alert('Voucher kh√¥ng √°p d·ª•ng cho s·∫£n ph·∫©m n√†y!');
                        return;
                    }
                }
                
                // L∆∞u voucher v√†o localStorage cho s·∫£n ph·∫©m n√†y
                const appliedVoucherKey = `phuclong_selected_voucher_${productId}`;
                const appliedVoucherDataKey = `phuclong_selected_voucher_data_${productId}`;
                localStorage.setItem(appliedVoucherKey, voucherCode);
                localStorage.setItem(appliedVoucherDataKey, JSON.stringify(result));
                
                // Reload vouchers cho s·∫£n ph·∫©m n√†y
                loadVouchersForProduct(productId);
                
                // Reload cart summary
                updateCartSummaryFromCheckboxes();
                
                alert(`ƒê√£ √°p d·ª•ng voucher ${voucherCode} cho s·∫£n ph·∫©m!`);
            } catch (error) {
                console.error('Error applying voucher to product:', error);
                alert('L·ªói khi √°p d·ª•ng voucher. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        }
        
        // X√≥a voucher kh·ªèi m·ªôt s·∫£n ph·∫©m
        function removeVoucherFromProduct(productId, voucherCode) {
            const appliedVoucherKey = `phuclong_selected_voucher_${productId}`;
            const appliedVoucherDataKey = `phuclong_selected_voucher_data_${productId}`;
            localStorage.removeItem(appliedVoucherKey);
            localStorage.removeItem(appliedVoucherDataKey);
            
            // Reload vouchers cho s·∫£n ph·∫©m n√†y
            loadVouchersForProduct(productId);
            
            // Reload cart summary
            updateCartSummaryFromCheckboxes();
        }
        
        // C·∫≠p nh·∫≠t cart summary d·ª±a tr√™n c√°c checkbox ƒë∆∞·ª£c tick
        function updateCartSummaryFromCheckboxes() {
            const productContainer = document.querySelector('#productList');
            if (!productContainer) return;
            
            const checkedItems = [];
            const checkboxes = productContainer.querySelectorAll('.product-checkbox-input');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const productItem = checkbox.closest('.product-item');
                    const productId = checkbox.getAttribute('data-product-id');
                    
                    // T√¨m item trong cartItems
                    const item = cartItems.find(i => (i.product_id || i.id) === productId);
                    if (item) {
                        checkedItems.push(item);
                    }
                }
            });
            
            updateCartSummaryWithVoucher(checkedItems);
            updateCheckoutButton(checkedItems.length > 0);
        }
        
        // C·∫≠p nh·∫≠t cart summary v·ªõi voucher
        function updateCartSummaryWithVoucher(cart) {
            let subtotal = 0;
            let totalDiscount = 0;
            
            // T√≠nh subtotal v√† discount cho t·ª´ng s·∫£n ph·∫©m
            cart.forEach(item => {
                const productId = String(item.product_id || item.id || item._id || item.sku || '');
                const itemPrice = item.price || 0;
                const itemQuantity = item.quantity || 1;
                const itemSubtotal = itemPrice * itemQuantity;
                
                subtotal += itemSubtotal;
                
                // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng cho s·∫£n ph·∫©m n√†y
                const appliedVoucherKey = `phuclong_selected_voucher_${productId}`;
                const appliedVoucherDataKey = `phuclong_selected_voucher_data_${productId}`;
                const appliedVoucher = localStorage.getItem(appliedVoucherKey);
                const appliedVoucherData = localStorage.getItem(appliedVoucherDataKey);
                
                if (appliedVoucher && appliedVoucherData) {
                    try {
                        const voucher = JSON.parse(appliedVoucherData);
                        let itemDiscount = 0;
                        
                        if (voucher.type === 'percent') {
                            itemDiscount = itemSubtotal * (voucher.value / 100);
                        } else if (voucher.type === 'fixed') {
                            itemDiscount = Math.min(voucher.value, itemSubtotal);
                        }
                        
                        totalDiscount += itemDiscount;
                    } catch (e) {
                        console.error(`Error parsing voucher data for product ${productId}:`, e);
                    }
                }
            });
            
            const total = subtotal - totalDiscount;
            
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            const discountRow = document.getElementById('discount-row');
            const discountAmount = document.getElementById('discount-amount');
            
            if (subtotalEl) subtotalEl.textContent = `‚Ç´${subtotal.toLocaleString('vi-VN')}`;
            
            // Hi·ªÉn th·ªã discount n·∫øu c√≥
            if (totalDiscount > 0) {
                if (discountRow) discountRow.style.display = 'flex';
                if (discountAmount) discountAmount.textContent = `-‚Ç´${totalDiscount.toLocaleString('vi-VN')}`;
            } else {
                if (discountRow) discountRow.style.display = 'none';
            }
            
            if (totalEl) totalEl.textContent = `‚Ç´${total.toLocaleString('vi-VN')}`;
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t checkout
        function updateCheckoutButton(hasSelectedItems) {
            const checkoutBtn = document.querySelector('.checkout-btn');
            if (!checkoutBtn) return;
            
            if (hasSelectedItems) {
                checkoutBtn.disabled = false;
                checkoutBtn.style.opacity = '1';
                checkoutBtn.style.cursor = 'pointer';
                checkoutBtn.style.backgroundColor = ''; // D√πng m√†u m·∫∑c ƒë·ªãnh t·ª´ CSS
            } else {
                checkoutBtn.disabled = true;
                checkoutBtn.style.opacity = '0.5';
                checkoutBtn.style.cursor = 'not-allowed';
                checkoutBtn.style.backgroundColor = '#ccc'; // M√†u x√°m
            }
        }

        // Update quantity via API
        async function updateQuantityAPI(productId, quantity) {
            try {
                const { user_id, session_id } = getCartIdentifiers();
                const sessionId = session_id || localStorage.getItem('phuclong_session_id');
                
                const formData = new FormData();
                formData.append('product_id', productId);
                formData.append('quantity', String(Math.max(0, quantity)));
                if (user_id) {
                    formData.append('user_id', user_id);
                }
                if (sessionId) {
                    formData.append('session_id', sessionId);
                }
                
                const response = await fetch('/api/carts/item', {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.ok) {
                    await loadCartData();
                    // C·∫≠p nh·∫≠t l·∫°i summary sau khi thay ƒë·ªïi quantity
                    updateCartSummaryFromCheckboxes();
                } else {
                    const result = await response.json();
                    alert(result.detail || 'L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng');
            }
        }

        // Remove item via API
        async function removeFromCartAPI(productId) {
            try {
                const { user_id, session_id } = getCartIdentifiers();
                const sessionId = session_id || localStorage.getItem('phuclong_session_id');
                
                let apiUrl = `/api/carts/item?product_id=${encodeURIComponent(productId)}`;
                if (user_id) {
                    apiUrl += `&user_id=${encodeURIComponent(user_id)}`;
                }
                if (sessionId) {
                    apiUrl += `&session_id=${encodeURIComponent(sessionId)}`;
                }
                
                const response = await fetch(apiUrl, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadCartData();
                } else {
                    const result = await response.json();
                    alert(result.detail || 'L·ªói khi x√≥a s·∫£n ph·∫©m');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('L·ªói khi x√≥a s·∫£n ph·∫©m');
            }
        }

        function updateCartSummary(cartItems) {
            // T√≠nh t·ªïng ch·ªâ t·ª´ c√°c items ƒë∆∞·ª£c truy·ªÅn v√†o (ƒë√£ ƒë∆∞·ª£c filter b·ªüi checkbox)
            const subtotal = cartItems.reduce((total, item) => total + ((item.price || 0) * (item.quantity || 1)), 0);
            const total = subtotal; // No shipping for now
            
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            if (subtotalEl) subtotalEl.textContent = `‚Ç´${subtotal.toLocaleString('vi-VN')}`;
            if (totalEl) totalEl.textContent = `‚Ç´${total.toLocaleString('vi-VN')}`;
        }

        async function clearCart() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng?')) {
                try {
                    const { user_id, session_id } = getCartIdentifiers();
                    const sessionId = session_id || localStorage.getItem('phuclong_session_id');
                    
                    let apiUrl = '/api/carts?';
                    if (user_id) {
                        apiUrl += `user_id=${encodeURIComponent(user_id)}`;
                    } else if (sessionId) {
                        apiUrl += `session_id=${encodeURIComponent(sessionId)}`;
                    }
                    
                    const response = await fetch(apiUrl, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                localStorage.removeItem('phuclong_cart');
                        await loadCartData();
                alert('ƒê√£ x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng!');
                    } else {
                        const result = await response.json();
                        alert(result.detail || 'L·ªói khi x√≥a gi·ªè h√†ng');
                    }
                } catch (error) {
                    console.error('Error clearing cart:', error);
                    localStorage.removeItem('phuclong_cart');
                    await loadCartData();
                    alert('ƒê√£ x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng!');
                }
            }
        }

        function goToHome() {
            window.location.href = '../Home/home.html';
        }
        
        // X·ª≠ l√Ω checkout - ch·ªâ checkout c√°c s·∫£n ph·∫©m ƒë∆∞·ª£c tick
        function handleCheckout() {
            const productContainer = document.querySelector('#productList');
            if (!productContainer) return;
            
            const checkedItems = [];
            const checkboxes = productContainer.querySelectorAll('.product-checkbox-input:checked');
            
            checkboxes.forEach(checkbox => {
                const productId = checkbox.getAttribute('data-product-id');
                const item = cartItems.find(i => (i.product_id || i.id) === productId);
                if (item) {
                    checkedItems.push(item);
                }
            });
            
            if (checkedItems.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
                return;
            }
            
            // L∆∞u selected items v√†o localStorage ƒë·ªÉ checkout page s·ª≠ d·ª•ng
            localStorage.setItem('phuclong_checkout_items', JSON.stringify(checkedItems));
            
            // Chuy·ªÉn ƒë·∫øn trang checkout
            window.location.href = '/ClientSite/checkout-shipping.html';
        }

        // Debug function to check localStorage
        function debugCart() {
            console.log('=== CART DEBUG ===');
            console.log('localStorage phuclong_cart:', localStorage.getItem('phuclong_cart'));
            console.log('Parsed cart:', JSON.parse(localStorage.getItem('phuclong_cart') || '[]'));
            console.log('==================');
        }

        // Make debug function global
        window.debugCart = debugCart;
        
        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }
        
        // Load vouchers cho cart
        async function loadVouchers() {
            console.log('loadVouchers() called');
            const voucherList = document.getElementById('voucher-list');
            const voucherDropdown = document.getElementById('voucher-dropdown');
            
            if (!voucherList) {
                console.error('voucher-list element not found!');
                return;
            }
            
            if (!voucherDropdown) {
                console.error('voucher-dropdown element not found!');
                return;
            }
            
            console.log('voucher-list and voucher-dropdown found');
            
            try {
                // L·∫•y cart items t·ª´ API ho·∫∑c localStorage
                const cartItems = await fetchCartFromAPI();
                const subtotal = cartItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
                
                // L·∫•y t·∫•t c·∫£ product IDs t·ª´ c√°c item
                const productIds = [];
                cartItems.forEach(item => {
                    const id1 = item._id ? String(item._id) : null;
                    const id2 = item.product_id ? String(item.product_id) : null;
                    const id3 = item.id ? String(item.id) : null;
                    const id4 = item.sku ? String(item.sku) : null;
                    
                    [id1, id2, id3, id4].forEach(id => {
                        if (id && id !== 'undefined' && id !== 'null' && !productIds.includes(id)) {
                            productIds.push(id);
                        }
                    });
                });
                
                console.log('Cart items:', cartItems);
                console.log('Product IDs extracted:', productIds);
                console.log('Subtotal:', subtotal);
                
                const response = await fetch('/api/vouchers?status_q=active&pageSize=50');
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    voucherList.innerHTML = '';
                    
                    const now = new Date();
                    let hasApplicableVouchers = false;
                    let applicableCount = 0;
                    
                    result.data.forEach(voucher => {
                        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                        if (voucher.status !== 'active') return;
                        
                        // Ki·ªÉm tra th·ªùi gian
                        if (voucher.start_at) {
                            const startAt = new Date(voucher.start_at);
                            if (now < startAt) return;
                        }
                        if (voucher.end_at) {
                            const endAt = new Date(voucher.end_at);
                            if (now > endAt) return;
                        }
                        
                        // Ki·ªÉm tra applicable_product_ids
                        let productMatch = true;
                        if (voucher.applicable_product_ids && Array.isArray(voucher.applicable_product_ids) && voucher.applicable_product_ids.length > 0) {
                            const applicableIds = voucher.applicable_product_ids.map(id => String(id));
                            productMatch = productIds.some(id => applicableIds.includes(id));
                            if (!productMatch) return;
                        }
                        
                        // Ki·ªÉm tra min_order_value
                        if (voucher.min_order_value && voucher.min_order_value > 0) {
                            if (subtotal < voucher.min_order_value) return;
                        }
                        
                        hasApplicableVouchers = true;
                        applicableCount++;
                        
                        // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng
                        const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
                        const isApplied = appliedVoucher && appliedVoucher === voucher.code;
                        
                        const voucherCard = document.createElement('div');
                        
                        // N·∫øu voucher ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng, d√πng n·ªÅn xanh l√°
                        if (isApplied) {
                            voucherCard.style.cssText = 'padding: 10px; background: #d4edda; border: 2px solid #28a745; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s;';
                        } else {
                            voucherCard.style.cssText = 'padding: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s;';
                        }
                        
                        voucherCard.onmouseover = () => {
                            if (!isApplied) {
                                voucherCard.style.borderColor = '#fb2e86';
                                voucherCard.style.background = '#fff';
                            }
                        };
                        voucherCard.onmouseout = () => {
                            if (isApplied) {
                                voucherCard.style.borderColor = '#28a745';
                                voucherCard.style.background = '#d4edda';
                            } else {
                                voucherCard.style.borderColor = '#ddd';
                                voucherCard.style.background = '#fff';
                            }
                        };
                        
                        const discountText = voucher.type === 'percent' 
                            ? `Gi·∫£m ${voucher.value}%` 
                            : `Gi·∫£m ${formatPrice(voucher.value)}`;
                        
                        // T·∫°o elements b·∫±ng DOM
                        const cardContent = document.createElement('div');
                        cardContent.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
                        
                        const leftDiv = document.createElement('div');
                        
                        const codeStrong = document.createElement('strong');
                        codeStrong.style.color = isApplied ? '#155724' : '#fb2e86';
                        codeStrong.textContent = voucher.code;
                        leftDiv.appendChild(codeStrong);
                        
                        const discountDiv = document.createElement('div');
                        discountDiv.style.cssText = 'font-size: 14px; color: #666; margin-top: 4px;';
                        discountDiv.textContent = discountText;
                        leftDiv.appendChild(discountDiv);
                        
                        // Hi·ªÉn th·ªã "ƒê√£ √°p d·ª•ng" n·∫øu voucher ƒëang ƒë∆∞·ª£c √°p d·ª•ng
                        if (isApplied) {
                            const appliedLabel = document.createElement('div');
                            appliedLabel.style.cssText = 'font-size: 12px; color: #155724; margin-top: 4px; font-weight: 600;';
                            appliedLabel.textContent = '‚úì ƒê√£ √°p d·ª•ng';
                            leftDiv.appendChild(appliedLabel);
                        }
                        
                        if (voucher.description) {
                            const descDiv = document.createElement('div');
                            descDiv.style.cssText = 'font-size: 12px; color: #999; margin-top: 2px;';
                            descDiv.textContent = voucher.description;
                            leftDiv.appendChild(descDiv);
                        }
                        
                        if (voucher.min_order_value && voucher.min_order_value > 0) {
                            const conditionDiv = document.createElement('div');
                            conditionDiv.style.cssText = 'font-size: 11px; color: #ff9800; margin-top: 2px;';
                            conditionDiv.textContent = `ƒê∆°n t·ªëi thi·ªÉu: ${formatPrice(voucher.min_order_value)}`;
                            leftDiv.appendChild(conditionDiv);
                        }
                        
                        // N·∫øu ƒë√£ √°p d·ª•ng, hi·ªÉn th·ªã n√∫t "H·ªßy √°p d·ª•ng" thay v√¨ "√Åp d·ª•ng"
                        const applyBtn = document.createElement('button');
                        if (isApplied) {
                            applyBtn.textContent = 'H·ªßy √°p d·ª•ng';
                            applyBtn.style.cssText = 'background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;';
                            applyBtn.onclick = (e) => {
                                e.stopPropagation();
                                removeVoucher();
                            };
                        } else {
                            applyBtn.textContent = '√Åp d·ª•ng';
                            applyBtn.style.cssText = 'background: #fb2e86; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;';
                            applyBtn.onclick = (e) => {
                                e.stopPropagation();
                                applyVoucherToOrder(voucher.code);
                            };
                        }
                        
                        cardContent.appendChild(leftDiv);
                        cardContent.appendChild(applyBtn);
                        voucherCard.appendChild(cardContent);
                        voucherList.appendChild(voucherCard);
                    });
                    
                    // Update voucher count
                    const voucherCount = document.getElementById('voucher-count');
                    if (voucherCount) voucherCount.textContent = applicableCount;
                    
                    // Hi·ªÉn th·ªã dropdown n·∫øu c√≥ voucher
                    if (hasApplicableVouchers) {
                        console.log(`Found ${applicableCount} applicable vouchers, showing dropdown`);
                        voucherDropdown.style.display = 'block';
                    } else {
                        console.log('No applicable vouchers found, hiding dropdown');
                        voucherDropdown.style.display = 'none';
                    }
                    
                    if (!hasApplicableVouchers) {
                        voucherList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">Kh√¥ng c√≥ voucher kh·∫£ d·ª•ng cho ƒë∆°n h√†ng n√†y</div>';
                    }
                } else {
                    console.log('No vouchers returned from API');
                    voucherDropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
            }
        }
        
        // √Åp d·ª•ng voucher v√†o ƒë∆°n h√†ng
        async function applyVoucherToOrder(voucherCodeParam = null) {
            const voucherCode = voucherCodeParam || '';
            if (!voucherCode) {
                alert('Vui l√≤ng ch·ªçn voucher!');
                return;
            }
            
            try {
                const response = await fetch(`/api/vouchers/${voucherCode}`);
                const result = await response.json();
                
                if (!result.code) {
                    alert('Voucher kh√¥ng t·ªìn t·∫°i!');
                    return;
                }
                
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                const now = new Date();
                const cartItems = await fetchCartFromAPI();
                const subtotal = cartItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
                const productIds = [];
                cartItems.forEach(item => {
                    const id1 = item._id ? String(item._id) : null;
                    const id2 = item.product_id ? String(item.product_id) : null;
                    const id3 = item.id ? String(item.id) : null;
                    const id4 = item.sku ? String(item.sku) : null;
                    [id1, id2, id3, id4].forEach(id => {
                        if (id && id !== 'undefined' && id !== 'null' && !productIds.includes(id)) {
                            productIds.push(id);
                        }
                    });
                });
                
                // Ki·ªÉm tra status
                if (result.status !== 'active') {
                    alert('Voucher kh√¥ng c√≤n hi·ªáu l·ª±c!');
                    return;
                }
                
                // Ki·ªÉm tra th·ªùi gian hi·ªáu l·ª±c
                if (result.start_at) {
                    const startAt = new Date(result.start_at);
                    if (now < startAt) {
                        alert('Voucher ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c!');
                        return;
                    }
                }
                if (result.end_at) {
                    const endAt = new Date(result.end_at);
                    if (now > endAt) {
                        alert('Voucher ƒë√£ h·∫øt h·∫°n!');
                        return;
                    }
                }
                
                // Ki·ªÉm tra min_order_value
                if (result.min_order_value && result.min_order_value > 0) {
                    if (subtotal < result.min_order_value) {
                        alert(`Voucher y√™u c·∫ßu ƒë∆°n h√†ng t·ªëi thi·ªÉu ${formatPrice(result.min_order_value)}!`);
                        return;
                    }
                }
                
                // Ki·ªÉm tra applicable_product_ids
                if (result.applicable_product_ids && result.applicable_product_ids.length > 0) {
                    const applicableIds = result.applicable_product_ids.map(id => String(id));
                    const hasMatchingProduct = productIds.some(id => applicableIds.includes(id));
                    if (!hasMatchingProduct) {
                        alert('Voucher kh√¥ng √°p d·ª•ng cho s·∫£n ph·∫©m trong gi·ªè h√†ng!');
                        return;
                    }
                }
                
                // L∆∞u voucher v√†o localStorage
                localStorage.setItem('phuclong_selected_voucher', voucherCode);
                localStorage.setItem('phuclong_selected_voucher_data', JSON.stringify(result));
                
                // Hi·ªÉn th·ªã voucher ƒë√£ √°p d·ª•ng badge
                const badge = document.getElementById('voucher-applied-badge');
                const badgeCode = document.getElementById('applied-voucher-code-display');
                if (badge && badgeCode) {
                    badgeCode.textContent = voucherCode;
                    badge.style.display = 'block';
                }
                
                // Reload cart summary ƒë·ªÉ t√≠nh l·∫°i gi√°
                updateCartSummaryFromCheckboxes();
                
                // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI
                loadVouchers();
                
                alert(`ƒê√£ √°p d·ª•ng voucher ${voucherCode}!`);
            } catch (error) {
                console.error('Error applying voucher:', error);
                alert('L·ªói khi √°p d·ª•ng voucher. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        }
        
        // X√≥a voucher
        function removeVoucher() {
            localStorage.removeItem('phuclong_selected_voucher');
            localStorage.removeItem('phuclong_selected_voucher_data');
            
            // ·∫®n badge
            const badge = document.getElementById('voucher-applied-badge');
            if (badge) {
                badge.style.display = 'none';
            }
            
            // Reload cart summary ƒë·ªÉ t√≠nh l·∫°i gi√°
            updateCartSummaryFromCheckboxes();
            
            // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI
            loadVouchers();
        }
        
        // Load vouchers khi trang load - ch·ªâ hi·ªÉn th·ªã badge n·∫øu c√≥ voucher ƒë√£ √°p d·ª•ng
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng t·ª´ tr∆∞·ªõc
            const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
            if (appliedVoucher) {
                const badge = document.getElementById('voucher-applied-badge');
                const badgeCode = document.getElementById('applied-voucher-code-display');
                if (badge && badgeCode) {
                    badgeCode.textContent = appliedVoucher;
                    badge.style.display = 'block';
                }
            }
            
            // loadVouchers() s·∫Ω ƒë∆∞·ª£c g·ªçi t·ª´ loadCartData() sau khi cart ƒë√£ load xong
        });
    </script>
</body>
</html>
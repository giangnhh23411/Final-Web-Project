<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Phuc Long</title>
    <link rel="stylesheet" href="/Assets/Components/header-footer.css">
    <link rel="stylesheet" href="/Assets/CSS/shopping-cart.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Alata:wght@400&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header Section - Dynamic -->
        <div id="site-header"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="cart-container">
                <!-- Left Column - Product List -->
                <div class="cart-left">
                    <div class="cart-table">
                        <div class="table-header">
                            <div class="col-checkbox">
                                <input type="checkbox" id="selectAll" class="select-all-checkbox">
                            </div>
                            <div class="col-product">Product</div>
                            <div class="col-price">Price</div>
                            <div class="col-quantity">Quantity</div>
                            <div class="col-total">Total</div>
                            <div class="col-action">Action</div>
                        </div>
                        
                        <!-- Product Items - Dynamic Content -->
                        <div class="product-list" id="productList">
                            <!-- Cart items will be loaded here dynamically -->
                        </div>
                    </div>
                    
                    <div class="cart-actions">
                        <button class="update-cart-btn" onclick="loadCartData()">Update Cart</button>
                        <button class="clear-cart-btn" onclick="clearCart()">Clear Cart</button>
                    </div>
                </div>

                <!-- Right Column - Cart Summary -->
                <div class="cart-right">
                    <div class="cart-summary">
                        <h3>Cart Totals</h3>
                        <div class="summary-row">
                            <span>Subtotals:</span>
                            <span id="subtotal">‚Ç´0</span>
                        </div>
                        <div class="summary-row">
                            <span>Totals:</span>
                            <span id="total">‚Ç´0</span>
                        </div>
                        <div class="shipping-info">
                            <span class="checkmark">‚úì</span>
                            <span>Shipping & taxes calculated at checkout</span>
                        </div>
                        <button class="checkout-btn" id="checkout-btn" onclick="handleCheckout()">Proceed To Checkout</button>
                        <div class="calculate-shipping">
                            <h4>Calculate Shopping</h4>
                        </div>
                    </div>

                    <!-- Chat Icon -->
                    <div class="chat-icon-container">
                        <div class="chat-icon-btn" onclick="toggleChat()">
                            <span class="chat-icon">üí¨</span>
                            <span class="notification-dot">1</span>
                        </div>
                    </div>

                    <!-- Chat Widget (Hidden by default) -->
                    <div class="chat-widget" id="chatWidget" style="display: none;">
                        <div class="chat-header">
                            <h4>Chat</h4>
                            <button class="close-chat-btn" onclick="toggleChat()">√ó</button>
                        </div>
                        <div class="chat-content">
                            <div class="chat-sidebar">
                                <div class="pinned-conversations">
                                    <h5>üìå Pinned Conversations</h5>
                                    <div class="conversation-item">
                                        <span>Jane Carr</span>
                                        <span class="notification">1</span>
                                    </div>
                                    <div class="conversation-item">
                                        <span>Angel Lubin</span>
                                    </div>
                                    <div class="conversation-item">
                                        <span>Kaiya Levin</span>
                                        <span class="notification">1</span>
                                    </div>
                                    <div class="conversation-item">
                                        <span>Phillip Aminoff</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-main">
                                <div class="chat-message">
                                    <div class="message-bubble">Hey!</div>
                                </div>
                                <div class="chat-input">
                                    <button class="attach-btn">+</button>
                                    <input type="text" placeholder="Message">
                                    <button class="mic-btn">üé§</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Section - Dynamic -->
        <div id="site-footer"></div>
    </div>

    <script>
        function toggleChat() {
            const chatWidget = document.getElementById('chatWidget');
            if (chatWidget.style.display === 'none') {
                chatWidget.style.display = 'block';
            } else {
                chatWidget.style.display = 'none';
            }
        }

        // Close chat when clicking outside
        document.addEventListener('click', function(event) {
            const chatWidget = document.getElementById('chatWidget');
            const chatIconBtn = document.querySelector('.chat-icon-btn');
            
            if (!chatWidget.contains(event.target) && !chatIconBtn.contains(event.target)) {
                chatWidget.style.display = 'none';
            }
        });

        // Load cart data from localStorage when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any existing sample data first
            clearSampleData();
            // Then load real cart data
            loadCartData();
        });

        function clearSampleData() {
            // Remove any hardcoded sample data
            const productContainer = document.querySelector('#productList');
            if (productContainer) {
                productContainer.innerHTML = '';
            }
        }
    </script>
    <!-- Load shared header and footer - MUST be loaded first -->
    <script src="/Assets/Components/layout.js" defer></script>
    <script src="../Assets/JS/cart-manager.js"></script>
    <script>
        // L·∫•y user_id v√† session_id
        function getCartIdentifiers() {
            const currentUser = JSON.parse(localStorage.getItem('phuclong_current_user') || 'null');
            const sessionId = localStorage.getItem('phuclong_session_id') || null;
            
            return {
                user_id: currentUser ? (currentUser.id || currentUser._id) : null,
                session_id: sessionId
            };
        }
        
        // Fetch cart t·ª´ API
        async function fetchCartFromAPI() {
            try {
                const { user_id, session_id } = getCartIdentifiers();
                let apiUrl = '/api/carts?';
                
                if (user_id) {
                    apiUrl += `user_id=${encodeURIComponent(user_id)}`;
                } else if (session_id) {
                    apiUrl += `session_id=${encodeURIComponent(session_id)}`;
                }
                
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (result.data) {
                    // L∆∞u session_id n·∫øu c√≥
                    if (result.data.session_id && !session_id) {
                        localStorage.setItem('phuclong_session_id', result.data.session_id);
                    }
                    
                    return result.data.items || [];
                }
                
                return [];
            } catch (error) {
                console.error('Error fetching cart:', error);
                // Fallback: d√πng LocalStorage
                return JSON.parse(localStorage.getItem('phuclong_cart') || '[]');
            }
        }
        
        async function loadCartData() {
            console.log('Loading cart data from API...');
            const productContainer = document.querySelector('#productList');
            
            if (!productContainer) {
                console.error('Product container not found!');
                return;
            }
            
            // Fetch cart t·ª´ API
            cartItems = await fetchCartFromAPI();
            console.log('Cart items from API:', cartItems);
            
            // C·∫≠p nh·∫≠t LocalStorage ƒë·ªÉ sync
            const localCart = cartItems.map(item => ({
                id: item.product_id || item.id,
                name: item.name,
                price: item.price,
                image: item.image || '',
                quantity: item.quantity || 1
            }));
            localStorage.setItem('phuclong_cart', JSON.stringify(localCart));
            
            if (cartItems.length === 0) {
                productContainer.innerHTML = `
                    <div class="empty-cart" style="
                        text-align: center;
                        padding: 60px 20px;
                        background-color: #f8f9fa;
                        border-radius: 8px;
                        margin: 20px 0;
                    ">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 24px;">Gi·ªè h√†ng tr·ªëng</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 16px;">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng.</p>
                        <a href="/" style="
                            background-color: #fb2e86;
                            color: white;
                            padding: 12px 24px;
                            text-decoration: none;
                            border-radius: 4px;
                            font-weight: 600;
                            display: inline-block;
                        ">Ti·∫øp t·ª•c mua s·∫Øm</a>
                    </div>
                `;
                updateCartSummary([]);
                return;
            }

            let html = '';
            cartItems.forEach((item, index) => {
                const productId = item.product_id || item.id;
                const imagePath = item.image || '';
                
                // X·ª≠ l√Ω image path: n·∫øu ƒë√£ l√† full URL (http/https) th√¨ d√πng tr·ª±c ti·∫øp
                let imageSrc = '';
                if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                    imageSrc = imagePath;
                } else if (imagePath.startsWith('/')) {
                    imageSrc = imagePath;
                } else if (imagePath) {
                    imageSrc = `/Assets/images/${imagePath}`;
                } else {
                    imageSrc = '/Assets/images/LogoPhucLong.png'; // Default image
                }
                
                html += `
                    <div class="product-item" data-product-id="${productId}">
                        <div class="product-checkbox">
                            <input type="checkbox" class="product-checkbox-input" checked data-product-id="${productId}">
                        </div>
                        <div class="product-details">
                            <div class="product-image">
                                <img src="${imageSrc}" alt="${item.name}" onerror="this.src='/Assets/images/LogoPhucLong.png'">
                            </div>
                            <div class="product-info">
                                <h3>${item.name}</h3>
                            </div>
                        </div>
                        <div class="product-price">‚Ç´${(item.price || 0).toLocaleString('vi-VN')}</div>
                        <div class="product-quantity">
                            <button class="qty-btn minus" onclick="updateQuantityAPI('${productId}', ${(item.quantity || 1) - 1})">-</button>
                            <input type="number" value="${item.quantity || 1}" min="1" onchange="updateQuantityAPI('${productId}', parseInt(this.value))">
                            <button class="qty-btn plus" onclick="updateQuantityAPI('${productId}', ${(item.quantity || 1) + 1})">+</button>
                        </div>
                        <div class="product-total">‚Ç´${((item.price || 0) * (item.quantity || 1)).toLocaleString('vi-VN')}</div>
                        <div class="product-actions">
                            <button class="delete-btn" onclick="removeFromCartAPI('${productId}')">Delete</button>
                        </div>
                    </div>
                `;
            });

            productContainer.innerHTML = html;
            
            // Th√™m event listeners cho checkboxes
            const checkboxes = productContainer.querySelectorAll('.product-checkbox-input');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCartSummaryFromCheckboxes);
            });
            
            updateCartSummaryFromCheckboxes();
            console.log('Cart data loaded successfully');
        }
        
        // C·∫≠p nh·∫≠t cart summary d·ª±a tr√™n c√°c checkbox ƒë∆∞·ª£c tick
        function updateCartSummaryFromCheckboxes() {
            const productContainer = document.querySelector('#productList');
            if (!productContainer) return;
            
            const checkedItems = [];
            const checkboxes = productContainer.querySelectorAll('.product-checkbox-input');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const productItem = checkbox.closest('.product-item');
                    const productId = checkbox.getAttribute('data-product-id');
                    
                    // T√¨m item trong cartItems
                    const item = cartItems.find(i => (i.product_id || i.id) === productId);
                    if (item) {
                        checkedItems.push(item);
                    }
                }
            });
            
            updateCartSummary(checkedItems);
            updateCheckoutButton(checkedItems.length > 0);
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t checkout
        function updateCheckoutButton(hasSelectedItems) {
            const checkoutBtn = document.querySelector('.checkout-btn');
            if (!checkoutBtn) return;
            
            if (hasSelectedItems) {
                checkoutBtn.disabled = false;
                checkoutBtn.style.opacity = '1';
                checkoutBtn.style.cursor = 'pointer';
                checkoutBtn.style.backgroundColor = ''; // D√πng m√†u m·∫∑c ƒë·ªãnh t·ª´ CSS
            } else {
                checkoutBtn.disabled = true;
                checkoutBtn.style.opacity = '0.5';
                checkoutBtn.style.cursor = 'not-allowed';
                checkoutBtn.style.backgroundColor = '#ccc'; // M√†u x√°m
            }
        }

        // Update quantity via API
        async function updateQuantityAPI(productId, quantity) {
            try {
                const { user_id, session_id } = getCartIdentifiers();
                const sessionId = session_id || localStorage.getItem('phuclong_session_id');
                
                const formData = new FormData();
                formData.append('product_id', productId);
                formData.append('quantity', String(Math.max(0, quantity)));
                if (user_id) {
                    formData.append('user_id', user_id);
                }
                if (sessionId) {
                    formData.append('session_id', sessionId);
                }
                
                const response = await fetch('/api/carts/item', {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.ok) {
                    await loadCartData();
                    // C·∫≠p nh·∫≠t l·∫°i summary sau khi thay ƒë·ªïi quantity
                    updateCartSummaryFromCheckboxes();
                } else {
                    const result = await response.json();
                    alert(result.detail || 'L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng');
            }
        }

        // Remove item via API
        async function removeFromCartAPI(productId) {
            try {
                const { user_id, session_id } = getCartIdentifiers();
                const sessionId = session_id || localStorage.getItem('phuclong_session_id');
                
                let apiUrl = `/api/carts/item?product_id=${encodeURIComponent(productId)}`;
                if (user_id) {
                    apiUrl += `&user_id=${encodeURIComponent(user_id)}`;
                }
                if (sessionId) {
                    apiUrl += `&session_id=${encodeURIComponent(sessionId)}`;
                }
                
                const response = await fetch(apiUrl, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadCartData();
                } else {
                    const result = await response.json();
                    alert(result.detail || 'L·ªói khi x√≥a s·∫£n ph·∫©m');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('L·ªói khi x√≥a s·∫£n ph·∫©m');
            }
        }

        function updateCartSummary(cartItems) {
            // T√≠nh t·ªïng ch·ªâ t·ª´ c√°c items ƒë∆∞·ª£c truy·ªÅn v√†o (ƒë√£ ƒë∆∞·ª£c filter b·ªüi checkbox)
            const subtotal = cartItems.reduce((total, item) => total + ((item.price || 0) * (item.quantity || 1)), 0);
            const total = subtotal; // No shipping for now
            
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            if (subtotalEl) subtotalEl.textContent = `‚Ç´${subtotal.toLocaleString('vi-VN')}`;
            if (totalEl) totalEl.textContent = `‚Ç´${total.toLocaleString('vi-VN')}`;
        }

        async function clearCart() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng?')) {
                try {
                    const { user_id, session_id } = getCartIdentifiers();
                    const sessionId = session_id || localStorage.getItem('phuclong_session_id');
                    
                    let apiUrl = '/api/carts?';
                    if (user_id) {
                        apiUrl += `user_id=${encodeURIComponent(user_id)}`;
                    } else if (sessionId) {
                        apiUrl += `session_id=${encodeURIComponent(sessionId)}`;
                    }
                    
                    const response = await fetch(apiUrl, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        localStorage.removeItem('phuclong_cart');
                        await loadCartData();
                        alert('ƒê√£ x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng!');
                    } else {
                        const result = await response.json();
                        alert(result.detail || 'L·ªói khi x√≥a gi·ªè h√†ng');
                    }
                } catch (error) {
                    console.error('Error clearing cart:', error);
                    localStorage.removeItem('phuclong_cart');
                    await loadCartData();
                    alert('ƒê√£ x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng!');
                }
            }
        }

        function goToHome() {
            window.location.href = '../Home/home.html';
        }
        
        // X·ª≠ l√Ω checkout - ch·ªâ checkout c√°c s·∫£n ph·∫©m ƒë∆∞·ª£c tick
        function handleCheckout() {
            const productContainer = document.querySelector('#productList');
            if (!productContainer) return;
            
            const checkedItems = [];
            const checkboxes = productContainer.querySelectorAll('.product-checkbox-input:checked');
            
            checkboxes.forEach(checkbox => {
                const productId = checkbox.getAttribute('data-product-id');
                const item = cartItems.find(i => (i.product_id || i.id) === productId);
                if (item) {
                    checkedItems.push(item);
                }
            });
            
            if (checkedItems.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
                return;
            }
            
            // L∆∞u selected items v√†o localStorage ƒë·ªÉ checkout page s·ª≠ d·ª•ng
            localStorage.setItem('phuclong_checkout_items', JSON.stringify(checkedItems));
            
            // Chuy·ªÉn ƒë·∫øn trang checkout
            window.location.href = '/ClientSite/checkout-shipping.html';
        }

        // Debug function to check localStorage
        function debugCart() {
            console.log('=== CART DEBUG ===');
            console.log('localStorage phuclong_cart:', localStorage.getItem('phuclong_cart'));
            console.log('Parsed cart:', JSON.parse(localStorage.getItem('phuclong_cart') || '[]'));
            console.log('==================');
        }

        // Make debug function global
        window.debugCart = debugCart;
    </script>
</body>
</html>
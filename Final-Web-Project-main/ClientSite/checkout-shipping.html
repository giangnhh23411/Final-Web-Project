<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout/Shipping - Phuc Long</title>
    <link rel="stylesheet" href="/Assets/Components/header-footer.css">
    <link rel="stylesheet" href="/Assets/CSS/checkout-shipping.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Alata:wght@400&display=swap" rel="stylesheet">
    <style>
        /* Voucher Dropdown Styles */
        .voucher-dropdown summary {
            list-style: none;
        }
        .voucher-dropdown summary::-webkit-details-marker {
            display: none;
        }
        .voucher-dropdown summary::marker {
            display: none;
        }
        /* Ch·ªâ rotate m≈©i t√™n, kh√¥ng rotate to√†n b·ªô summary */
        .voucher-dropdown[open] summary .arrow-icon {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }
        .voucher-dropdown summary .arrow-icon {
            transition: transform 0.3s;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section - Dynamic -->
        <div id="site-header"></div>

        <!-- Promotional Banner -->
        <section class="promo-banner">
            <img src="../Assets/images/checkout-shipping/1280x400-banner-web-20251010111718 1.png" alt="Game Promotion Banner" class="banner-image">
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-container">
                <!-- Breadcrumbs -->
                <div class="breadcrumbs">
                    <span class="breadcrumb-item">PHUC LONG</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">Cart</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">Information</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">Shipping</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">Payment</span>
                </div>

                <div class="checkout-container">
                    <!-- Left Column - Contact & Shipping Form -->
                    <div class="checkout-left">
                        <!-- Contact Information -->
                        <div class="form-section">
                            <h3 class="section-title">Contact Information</h3>
                            <div class="form-group">
                                <input type="text" id="contact-email" name="contact-email" placeholder="Email or mobile phone number" class="form-input" required>
                                <span class="error-message" id="error-contact-email"></span>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="newsletter">
                                <label for="newsletter">Keep me up to date on news and excluive offers</label>
                            </div>
                            <div class="login-link">
                                <a href="#">Already have an account? Log in</a>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        <div class="form-section">
                            <h3 class="section-title">Shipping Address</h3>
                            <div class="form-row">
                                <input type="text" id="first-name" name="first-name" placeholder="First name" class="form-input" required>
                                <input type="text" id="last-name" name="last-name" placeholder="Last name" class="form-input" required>
                            </div>
                            <span class="error-message" id="error-name"></span>
                            <div class="form-group">
                                <input type="text" id="address" name="address" placeholder="Address" class="form-input" required>
                                <span class="error-message" id="error-address"></span>
                            </div>
                            <div class="form-group">
                                <input type="text" id="apartment" name="apartment" placeholder="Apartment, suite, etc. (optional)" class="form-input">
                            </div>
                            <div class="form-group">
                                <input type="text" id="city" name="city" placeholder="City" class="form-input" required>
                                <span class="error-message" id="error-city"></span>
                            </div>
                            <div class="form-row">
                                <select id="country" name="country" class="form-input" required>
                                    <option value="">Select Country</option>
                                    <option value="Vietnam">Vietnam</option>
                                    <option value="Bangladesh">Bangladesh</option>
                                </select>
                                <input type="text" id="postal-code" name="postal-code" placeholder="Postal Code" class="form-input" required>
                            </div>
                            <span class="error-message" id="error-location"></span>
                        </div>

                        <button class="continue-btn" onclick="handleContinueToPayment()">Continue Shipping</button>
                    </div>

                    <!-- Right Column - Order Summary -->
                    <div class="checkout-right">
                        <div class="order-summary">
                            <h3 class="summary-title">Order Summary</h3>
                            
                            <!-- Product Items -->
                            <div class="product-items" id="order-summary-items">
                                <!-- S·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ localStorage -->
                                </div>
                                
                            <!-- Voucher Section - Badge hi·ªÉn th·ªã voucher ƒë√£ √°p d·ª•ng -->
                            <div id="voucher-applied-badge" style="display: none; margin: 20px 0; padding: 10px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: normal;">
                                üéüÔ∏è ƒê√£ √°p d·ª•ng voucher: <span id="applied-voucher-code-display"></span>
                                <button onclick="removeVoucher()" style="
                                    margin-left: 8px;
                                    background: rgba(255,255,255,0.3);
                                    color: white;
                                    border: 1px solid white;
                                    padding: 2px 6px;
                                    border-radius: 3px;
                                    cursor: pointer;
                                    font-size: 11px;
                                ">‚úï</button>
                                </div>
                                
                            <!-- Voucher Section - Dropdown -->
                            <details class="voucher-dropdown" id="voucher-dropdown" style="margin: 20px 0; display: none;">
                                <summary style="
                                    padding: 12px 16px;
                                    background: #f8f9fa;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    color: #333;
                                    list-style: none;
                                    user-select: none;
                                ">
                                    <span style="display: flex; align-items: center; justify-content: space-between;">
                                        <span>üéüÔ∏è Voucher kh·∫£ d·ª•ng (<span id="voucher-count">0</span>)</span>
                                        <span class="arrow-icon" style="font-size: 12px; color: #666;">‚ñº</span>
                                    </span>
                                </summary>
                                <div id="voucher-list" style="
                                    margin-top: 10px;
                                    padding: 15px;
                                    background: white;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    display: flex;
                                    flex-direction: column;
                                    gap: 8px;
                                    max-height: 300px;
                                    overflow-y: auto;
                                ">
                                    <!-- Vouchers will be loaded here -->
                                </div>
                            </details>

                            <!-- Summary Totals -->
                            <div class="summary-totals">
                                <div class="total-row">
                                    <span>Subtotals:</span>
                                    <span id="order-subtotal">0‚Ç´</span>
                                </div>
                                <div class="total-row">
                                    <span>Totals:</span>
                                    <span id="order-total">0‚Ç´</span>
                                </div>
                                <p class="shipping-note">Shipping & taxes calculated at checkout</p>
                            </div>

                            <button class="checkout-btn">Proceed To Checkout</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer Section - Dynamic -->
        <div id="site-footer"></div>
    </div>
    
    <script src="/Assets/Components/layout.js" defer></script>
    <script>
        // Load order summary t·ª´ localStorage
        function loadOrderSummary() {
            const checkoutItems = JSON.parse(localStorage.getItem('phuclong_checkout_items') || '[]');
            const itemsContainer = document.getElementById('order-summary-items');
            const subtotalEl = document.getElementById('order-subtotal');
            const totalEl = document.getElementById('order-total');
            
            if (checkoutItems.length === 0) {
                itemsContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</p>';
                subtotalEl.textContent = '0‚Ç´';
                totalEl.textContent = '0‚Ç´';
                return;
            }
            
            // Render items
            itemsContainer.innerHTML = checkoutItems.map(item => {
                const imagePath = item.image || '/Assets/images/LogoPhucLong.png';
                let imageSrc = imagePath;
                if (!imagePath.startsWith('http://') && !imagePath.startsWith('https://')) {
                    if (imagePath.startsWith('/')) {
                        imageSrc = imagePath;
                    } else {
                        imageSrc = '/Assets/images/' + imagePath;
                    }
                }
                
                const itemTotal = (item.price || 0) * (item.quantity || 1);
                return `
                    <div class="product-item">
                        <img src="${imageSrc}" alt="${item.name || 'Product'}" class="product-image" onerror="this.src='/Assets/images/LogoPhucLong.png'">
                        <div class="product-details">
                            <h4>${item.name || 'S·∫£n ph·∫©m'}</h4>
                            <p>Quantity: ${item.quantity || 1}</p>
                    </div>
                        <div class="product-price">${formatPrice(itemTotal)}</div>
                    </div>
                `;
            }).join('');
            
            // T√≠nh totals
            const subtotal = checkoutItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
            const shipping = 30000; // Fixed shipping cost
            
            // √Åp d·ª•ng voucher n·∫øu c√≥
            const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
            const appliedVoucherData = localStorage.getItem('phuclong_selected_voucher_data');
            let discount = 0;
            
            if (appliedVoucher) {
                // S·ª≠ d·ª•ng voucher data ƒë√£ l∆∞u ho·∫∑c load t·ª´ API
                let voucher = null;
                if (appliedVoucherData) {
                    try {
                        voucher = JSON.parse(appliedVoucherData);
                    } catch (e) {
                        console.error('Error parsing voucher data:', e);
                    }
                }
                
                if (voucher) {
                    // T√≠nh discount t·ª´ voucher data
                    if (voucher.type === 'percent') {
                        discount = subtotal * (voucher.value / 100);
                    } else if (voucher.type === 'fixed') {
                        discount = Math.min(voucher.value, subtotal);
                    }
                    updateTotals(subtotal, shipping, discount);
                } else {
                    // Load t·ª´ API n·∫øu ch∆∞a c√≥ data
                    fetch(`/api/vouchers/${appliedVoucher}`)
                        .then(res => res.json())
                        .then(voucher => {
                            if (voucher.type === 'percent') {
                                discount = subtotal * (voucher.value / 100);
                            } else if (voucher.type === 'fixed') {
                                discount = Math.min(voucher.value, subtotal);
                            }
                            // L∆∞u voucher data
                            localStorage.setItem('phuclong_selected_voucher_data', JSON.stringify(voucher));
                            updateTotals(subtotal, shipping, discount);
                        })
                        .catch(() => {
                            updateTotals(subtotal, shipping, 0);
                        });
                }
            } else {
                updateTotals(subtotal, shipping, 0);
            }
        }
        
        // Update totals v·ªõi voucher
        function updateTotals(subtotal, shipping, discount) {
            const subtotalEl = document.getElementById('order-subtotal');
            const totalEl = document.getElementById('order-total');
            const total = subtotal + shipping - discount;
            
            subtotalEl.textContent = formatPrice(subtotal);
            if (discount > 0) {
                // Hi·ªÉn th·ªã discount n·∫øu c√≥
                const discountRow = document.getElementById('discount-row');
                if (!discountRow) {
                    const totalsDiv = document.querySelector('.summary-totals');
                    const discountEl = document.createElement('div');
                    discountEl.id = 'discount-row';
                    discountEl.className = 'total-row';
                    discountEl.style.color = '#28a745';
                    discountEl.innerHTML = `
                        <span>Gi·∫£m gi√°:</span>
                        <span id="order-discount">-${formatPrice(discount)}</span>
                    `;
                    totalsDiv.insertBefore(discountEl, totalEl.parentElement);
                } else {
                    document.getElementById('order-discount').textContent = `-${formatPrice(discount)}`;
                }
            } else {
                const discountRow = document.getElementById('discount-row');
                if (discountRow) discountRow.remove();
            }
            totalEl.textContent = formatPrice(total);
        }
        
        // Load vouchers
        async function loadVouchers() {
            const voucherList = document.getElementById('voucher-list');
            if (!voucherList) return;
            
            try {
                const checkoutItems = JSON.parse(localStorage.getItem('phuclong_checkout_items') || '[]');
                const subtotal = checkoutItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
                
                // L·∫•y t·∫•t c·∫£ product IDs t·ª´ c√°c item (c√≥ th·ªÉ l√† id, product_id, _id, ho·∫∑c sku)
                // ∆Øu ti√™n _id ho·∫∑c product_id (MongoDB ObjectId) v√¨ voucher th∆∞·ªùng d√πng _id
                const productIds = [];
                checkoutItems.forEach(item => {
                    const id1 = item._id ? String(item._id) : null;
                    const id2 = item.product_id ? String(item.product_id) : null;
                    const id3 = item.id ? String(item.id) : null;
                    const id4 = item.sku ? String(item.sku) : null;
                    
                    // Th√™m t·∫•t c·∫£ c√°c ID c√≥ gi√° tr·ªã (kh√¥ng tr√πng l·∫∑p)
                    [id1, id2, id3, id4].forEach(id => {
                        if (id && id !== 'undefined' && id !== 'null' && !productIds.includes(id)) {
                            productIds.push(id);
                        }
                    });
                });
                
                console.log('=== CHECKOUT VOUCHER DEBUG ===');
                console.log('Checkout items:', JSON.stringify(checkoutItems, null, 2));
                console.log('Product IDs extracted (all variants):', productIds);
                console.log('Subtotal:', subtotal);
                console.log('Number of items:', checkoutItems.length);
                
                const response = await fetch('/api/vouchers?status_q=active&pageSize=50');
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    voucherList.innerHTML = '';
                    
                    const now = new Date();
                    let hasApplicableVouchers = false;
                    
                    result.data.forEach(voucher => {
                        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                        if (voucher.status !== 'active') {
                            console.log(`Voucher ${voucher.code}: Status kh√¥ng active`);
                            return;
                        }
                        
                        // Ki·ªÉm tra th·ªùi gian
                        if (voucher.start_at) {
                            const startAt = new Date(voucher.start_at);
                            if (now < startAt) {
                                console.log(`Voucher ${voucher.code}: Ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c`);
                                return;
                            }
                        }
                        if (voucher.end_at) {
                            const endAt = new Date(voucher.end_at);
                            if (now > endAt) {
                                console.log(`Voucher ${voucher.code}: ƒê√£ h·∫øt h·∫°n`);
                                return;
                            }
                        }
                        
                        // Ki·ªÉm tra applicable_product_ids TR∆Ø·ªöC min_order_value
                        // N·∫øu voucher c√≥ applicable_product_ids v√† kh√¥ng r·ªóng, th√¨ ph·∫£i c√≥ product kh·ªõp
                        // N·∫øu voucher KH√îNG c√≥ applicable_product_ids ho·∫∑c m·∫£ng r·ªóng, th√¨ √°p d·ª•ng cho t·∫•t c·∫£ s·∫£n ph·∫©m
                        let productMatch = true;
                        if (voucher.applicable_product_ids && Array.isArray(voucher.applicable_product_ids) && voucher.applicable_product_ids.length > 0) {
                            const applicableIds = voucher.applicable_product_ids.map(id => String(id));
                            productMatch = productIds.some(id => applicableIds.includes(id));
                            if (!productMatch) {
                                console.log(`Voucher ${voucher.code}: Kh√¥ng c√≥ product kh·ªõp. Product IDs: [${productIds.join(', ')}], Applicable IDs: [${applicableIds.join(', ')}]`);
                                return;
                            }
                        }
                        // N·∫øu kh√¥ng c√≥ applicable_product_ids ho·∫∑c m·∫£ng r·ªóng, voucher √°p d·ª•ng cho t·∫•t c·∫£ s·∫£n ph·∫©m
                        
                        // Ki·ªÉm tra min_order_value
                        // N·∫øu voucher c√≥ applicable_product_ids v√† product kh·ªõp, ki·ªÉm tra subtotal
                        // N·∫øu voucher kh√¥ng c√≥ applicable_product_ids, c≈©ng ki·ªÉm tra subtotal
                        if (voucher.min_order_value && voucher.min_order_value > 0) {
                            if (subtotal < voucher.min_order_value) {
                                console.log(`Voucher ${voucher.code}: Subtotal ${subtotal} < min_order_value ${voucher.min_order_value}`);
                                return;
                            }
                        }
                        
                        console.log(`Voucher ${voucher.code}: √Åp d·ª•ng ƒë∆∞·ª£c!`);
                        hasApplicableVouchers = true;
                        applicableCount++;
                        
                        // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng
                        const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
                        const isApplied = appliedVoucher && appliedVoucher === voucher.code;
                        
                        const voucherCard = document.createElement('div');
                        
                        // N·∫øu voucher ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng, d√πng n·ªÅn xanh l√°
                        if (isApplied) {
                            voucherCard.style.cssText = 'padding: 10px; background: #d4edda; border: 2px solid #28a745; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s;';
                        } else {
                            voucherCard.style.cssText = 'padding: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; margin-bottom: 8px; transition: all 0.3s;';
                        }
                        
                        voucherCard.onmouseover = () => {
                            if (!isApplied) {
                                voucherCard.style.borderColor = '#fb2e86';
                                voucherCard.style.background = '#fff';
                            }
                        };
                        voucherCard.onmouseout = () => {
                            if (isApplied) {
                                voucherCard.style.borderColor = '#28a745';
                                voucherCard.style.background = '#d4edda';
                            } else {
                                voucherCard.style.borderColor = '#ddd';
                                voucherCard.style.background = '#fff';
                            }
                        };
                        
                        const discountText = voucher.type === 'percent' 
                            ? `Gi·∫£m ${voucher.value}%` 
                            : `Gi·∫£m ${formatPrice(voucher.value)}`;
                        
                        // T·∫°o elements b·∫±ng DOM thay v√¨ innerHTML
                        const cardContent = document.createElement('div');
                        cardContent.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
                        
                        const leftDiv = document.createElement('div');
                        
                        const codeStrong = document.createElement('strong');
                        codeStrong.style.color = isApplied ? '#155724' : '#fb2e86';
                        codeStrong.textContent = voucher.code;
                        leftDiv.appendChild(codeStrong);
                        
                        const discountDiv = document.createElement('div');
                        discountDiv.style.cssText = 'font-size: 14px; color: #666; margin-top: 4px;';
                        discountDiv.textContent = discountText;
                        leftDiv.appendChild(discountDiv);
                        
                        // Hi·ªÉn th·ªã "ƒê√£ √°p d·ª•ng" n·∫øu voucher ƒëang ƒë∆∞·ª£c √°p d·ª•ng
                        if (isApplied) {
                            const appliedLabel = document.createElement('div');
                            appliedLabel.style.cssText = 'font-size: 12px; color: #155724; margin-top: 4px; font-weight: 600;';
                            appliedLabel.textContent = '‚úì ƒê√£ √°p d·ª•ng';
                            leftDiv.appendChild(appliedLabel);
                        }
                        
                        if (voucher.description) {
                            const descDiv = document.createElement('div');
                            descDiv.style.cssText = 'font-size: 12px; color: #999; margin-top: 2px;';
                            descDiv.textContent = voucher.description;
                            leftDiv.appendChild(descDiv);
                        }
                        
                        if (voucher.min_order_value && voucher.min_order_value > 0) {
                            const conditionDiv = document.createElement('div');
                            conditionDiv.style.cssText = 'font-size: 11px; color: #ff9800; margin-top: 2px;';
                            conditionDiv.textContent = `ƒê∆°n t·ªëi thi·ªÉu: ${formatPrice(voucher.min_order_value)}`;
                            leftDiv.appendChild(conditionDiv);
                        }
                        
                        // N·∫øu ƒë√£ √°p d·ª•ng, hi·ªÉn th·ªã n√∫t "H·ªßy √°p d·ª•ng" thay v√¨ "√Åp d·ª•ng"
                        const applyBtn = document.createElement('button');
                        if (isApplied) {
                            applyBtn.textContent = 'H·ªßy √°p d·ª•ng';
                            applyBtn.style.cssText = 'background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;';
                            applyBtn.onclick = (e) => {
                                e.stopPropagation();
                                removeVoucher();
                            };
                        } else {
                            applyBtn.textContent = '√Åp d·ª•ng';
                            applyBtn.style.cssText = 'background: #fb2e86; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;';
                            applyBtn.onclick = (e) => {
                                e.stopPropagation();
                                applyVoucherToOrder(voucher.code);
                            };
                        }
                        
                        cardContent.appendChild(leftDiv);
                        cardContent.appendChild(applyBtn);
                        voucherCard.appendChild(cardContent);
                        voucherList.appendChild(voucherCard);
                    });
                    
                    // Update voucher count
                    const voucherCount = document.getElementById('voucher-count');
                    if (voucherCount) voucherCount.textContent = applicableCount;
                    
                    // Hi·ªÉn th·ªã dropdown n·∫øu c√≥ voucher
                    const voucherDropdown = document.getElementById('voucher-dropdown');
                    if (voucherDropdown) {
                        if (hasApplicableVouchers) {
                            voucherDropdown.style.display = 'block';
                        } else {
                            voucherDropdown.style.display = 'none';
                        }
                    }
                    
                    if (!hasApplicableVouchers) {
                        voucherList.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">Kh√¥ng c√≥ voucher kh·∫£ d·ª•ng cho ƒë∆°n h√†ng n√†y</div>';
                    }
                } else {
                    // Kh√¥ng c√≥ voucher n√†o
                    const voucherDropdown = document.getElementById('voucher-dropdown');
                    if (voucherDropdown) {
                        voucherDropdown.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
            }
        }
        
        // √Åp d·ª•ng voucher v√†o ƒë∆°n h√†ng
        async function applyVoucherToOrder(voucherCodeParam = null) {
            const voucherCode = voucherCodeParam || (document.getElementById('voucher-code-input') ? document.getElementById('voucher-code-input').value.trim() : '');
            if (!voucherCode) {
                alert('Vui l√≤ng nh·∫≠p m√£ voucher!');
                return;
            }
            
            try {
                const response = await fetch(`/api/vouchers/${voucherCode}`);
                const result = await response.json();
                
                if (!result.code) {
                    alert('Voucher kh√¥ng t·ªìn t·∫°i!');
                    return;
                }
                
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                const now = new Date();
                const checkoutItems = JSON.parse(localStorage.getItem('phuclong_checkout_items') || '[]');
                const subtotal = checkoutItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
                // L·∫•y t·∫•t c·∫£ product IDs t·ª´ c√°c item
                const productIds = checkoutItems.map(item => {
                    return String(item.id || item.product_id || item._id || item.sku || '');
                }).filter(id => id && id !== 'undefined');
                
                // Ki·ªÉm tra status
                if (result.status !== 'active') {
                    alert('Voucher kh√¥ng c√≤n hi·ªáu l·ª±c!');
                    return;
                }
                
                // Ki·ªÉm tra th·ªùi gian hi·ªáu l·ª±c
                if (result.start_at) {
                    const startAt = new Date(result.start_at);
                    if (now < startAt) {
                        alert('Voucher ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c!');
                        return;
                    }
                }
                if (result.end_at) {
                    const endAt = new Date(result.end_at);
                    if (now > endAt) {
                        alert('Voucher ƒë√£ h·∫øt h·∫°n!');
                        return;
                    }
                }
                
                // Ki·ªÉm tra min_order_value
                if (result.min_order_value && result.min_order_value > 0) {
                    if (subtotal < result.min_order_value) {
                        alert(`Voucher y√™u c·∫ßu ƒë∆°n h√†ng t·ªëi thi·ªÉu ${formatPrice(result.min_order_value)}!`);
                        return;
                    }
                }
                
                // Ki·ªÉm tra applicable_product_ids
                if (result.applicable_product_ids && result.applicable_product_ids.length > 0) {
                    const applicableIds = result.applicable_product_ids.map(id => String(id));
                    const hasMatchingProduct = productIds.some(id => applicableIds.includes(id));
                    if (!hasMatchingProduct) {
                        alert('Voucher kh√¥ng √°p d·ª•ng cho s·∫£n ph·∫©m trong gi·ªè h√†ng!');
                        return;
                    }
                }
                
                // L∆∞u voucher v√†o localStorage
                localStorage.setItem('phuclong_selected_voucher', voucherCode);
                localStorage.setItem('phuclong_selected_voucher_data', JSON.stringify(result));
                
                // Hi·ªÉn th·ªã voucher ƒë√£ √°p d·ª•ng badge
                const badge = document.getElementById('voucher-applied-badge');
                const badgeCode = document.getElementById('applied-voucher-code-display');
                if (badge && badgeCode) {
                    badgeCode.textContent = voucherCode;
                    badge.style.display = 'block';
                }
                
                // Reload order summary ƒë·ªÉ t√≠nh l·∫°i gi√°
                loadOrderSummary();
                
                // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI (highlight voucher ƒë√£ √°p d·ª•ng)
                loadVouchers();
                
                alert(`ƒê√£ √°p d·ª•ng voucher ${voucherCode}!`);
            } catch (error) {
                console.error('Error applying voucher:', error);
                if (error.response && error.response.status === 404) {
                    alert('Voucher kh√¥ng t·ªìn t·∫°i!');
                } else {
                    alert('L·ªói khi √°p d·ª•ng voucher. Vui l√≤ng th·ª≠ l·∫°i!');
                }
            }
        }
        
        // X√≥a voucher
        function removeVoucher() {
            localStorage.removeItem('phuclong_selected_voucher');
            localStorage.removeItem('phuclong_selected_voucher_data');
            
            // ·∫®n badge
            const badge = document.getElementById('voucher-applied-badge');
            if (badge) {
                badge.style.display = 'none';
            }
            
            // X√≥a input n·∫øu c√≥
            const input = document.getElementById('voucher-code-input');
            if (input) {
                input.value = '';
            }
            
            // Reload order summary ƒë·ªÉ t√≠nh l·∫°i gi√°
            loadOrderSummary();
            
            // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI
            loadVouchers();
        }
        
        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }
        
        // Validate form
        function validateForm() {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-input').forEach(el => el.style.borderColor = '');
            
            // Validate contact email/phone
            const contactEmail = document.getElementById('contact-email').value.trim();
            if (!contactEmail) {
                showError('contact-email', 'Vui l√≤ng nh·∫≠p email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i');
                isValid = false;
            } else if (!isValidEmail(contactEmail) && !isValidPhone(contactEmail)) {
                showError('contact-email', 'Vui l√≤ng nh·∫≠p email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá');
                isValid = false;
            }
            
            // Validate first name
            const firstName = document.getElementById('first-name').value.trim();
            if (!firstName) {
                showError('first-name', 'Vui l√≤ng nh·∫≠p t√™n');
                isValid = false;
            }
            
            // Validate last name
            const lastName = document.getElementById('last-name').value.trim();
            if (!lastName) {
                showError('last-name', 'Vui l√≤ng nh·∫≠p h·ªç');
                isValid = false;
            }
            
            // Validate address
            const address = document.getElementById('address').value.trim();
            if (!address) {
                showError('address', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ');
                isValid = false;
            }
            
            // Validate city
            const city = document.getElementById('city').value.trim();
            if (!city) {
                showError('city', 'Vui l√≤ng nh·∫≠p th√†nh ph·ªë');
                isValid = false;
            }
            
            // Validate country
            const country = document.getElementById('country').value;
            if (!country) {
                showError('country', 'Vui l√≤ng ch·ªçn qu·ªëc gia');
                isValid = false;
            }
            
            // Validate postal code
            const postalCode = document.getElementById('postal-code').value.trim();
            if (!postalCode) {
                showError('postal-code', 'Vui l√≤ng nh·∫≠p m√£ b∆∞u ƒëi·ªán');
                isValid = false;
            }
            
            return isValid;
        }
        
        // Show error message
        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorId = 'error-' + fieldId;
            let errorEl = document.getElementById(errorId);
            
            if (!errorEl) {
                // T√¨m error element g·∫ßn nh·∫•t
                if (fieldId === 'first-name' || fieldId === 'last-name') {
                    errorEl = document.getElementById('error-name');
                } else if (fieldId === 'country' || fieldId === 'postal-code') {
                    errorEl = document.getElementById('error-location');
                } else {
                    errorEl = document.getElementById('error-' + fieldId);
                }
            }
            
            if (errorEl) {
                errorEl.textContent = message;
            }
            
            if (field) {
                field.style.borderColor = '#fb2e86';
            }
        }
        
        // Validate email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Validate phone (Vietnamese phone format)
        function isValidPhone(phone) {
            const phoneRegex = /^(\+84|0)[0-9]{9,10}$/;
            return phoneRegex.test(phone.replace(/\s/g, ''));
        }
        
        // X·ª≠ l√Ω chuy·ªÉn ƒë·∫øn trang payment
        function handleContinueToPayment() {
            // Validate form
            if (!validateForm()) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            
            // L·∫•y th√¥ng tin shipping t·ª´ form
            const email = document.getElementById('contact-email').value.trim();
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const address = document.getElementById('address').value.trim();
            const apartment = document.getElementById('apartment').value.trim();
            const city = document.getElementById('city').value.trim();
            const country = document.getElementById('country').value;
            const postalCode = document.getElementById('postal-code').value.trim();
            
            // L∆∞u shipping info v√†o localStorage
            const shippingInfo = {
                email: email,
                first_name: firstName,
                last_name: lastName,
                address: address,
                apartment: apartment,
                city: city,
                country: country,
                postal_code: postalCode
            };
            localStorage.setItem('phuclong_shipping_info', JSON.stringify(shippingInfo));
            
            // Chuy·ªÉn ƒë·∫øn trang payment
            window.location.href = '/ClientSite/payment.html';
        }
        
        // Load order summary v√† vouchers khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderSummary();
            
            // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng t·ª´ tr∆∞·ªõc
            const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
            if (appliedVoucher) {
                const badge = document.getElementById('voucher-applied-badge');
                const badgeCode = document.getElementById('applied-voucher-code-display');
                if (badge && badgeCode) {
                    badgeCode.textContent = appliedVoucher;
                    badge.style.display = 'block';
                }
            }
            
            // Load vouchers sau khi order summary ƒë√£ load
            setTimeout(() => {
                loadVouchers();
            }, 100);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - Phuc Long</title>
    <link rel="stylesheet" href="/Assets/Components/header-footer.css">
    <link rel="stylesheet" href="/Assets/CSS/order-details.css">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;500;600;700&family=Lato:wght@300;400;500;600;700&family=Alata&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header - Dynamic -->
    <div id="site-header"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <!-- Back Link -->
            <div class="back-link">
                <a href="/ClientSite/my-orders.html" class="back-btn"><<< Back to List</a>
            </div>

            <!-- Page Title -->
            <div class="page-title">
                <h1 id="order-title">Order Details • Loading...</h1>
            </div>

            <!-- Address Section -->
            <div class="address-section">
                <div class="billing-address">
                    <h3>BILLING ADDRESS</h3>
                    <div class="address-info" id="billing-address">
                        <p>Đang tải...</p>
                    </div>
                </div>
                <div class="shipping-address">
                    <h3>SHIPPING ADDRESS</h3>
                    <div class="address-info" id="shipping-address">
                        <p>Đang tải...</p>
                    </div>
                </div>
                <div class="order-summary">
                    <h3>ORDER SUMMARY</h3>
                    <div class="summary-info">
                        <p><strong id="order-id">ORDER ID: Loading...</strong></p>
                        <p><strong id="payment-method">PAYMENT METHOD: Loading...</strong></p>
                        <div class="summary-details">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="order-subtotal">₫0</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping:</span>
                                <span id="order-shipping">₫0</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="order-total">₫0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Status Tracker -->
            <div class="order-status-tracker" id="order-status-tracker">
                <div class="status-step" data-step="received">
                    <div class="status-icon">✓</div>
                    <span>Order received</span>
                </div>
                <div class="status-step" data-step="processing">
                    <div class="status-icon">02</div>
                    <span>Processing</span>
                </div>
                <div class="status-step" data-step="shipped">
                    <div class="status-icon">03</div>
                    <span>On the way</span>
                </div>
                <div class="status-step" data-step="delivered">
                    <div class="status-icon">04</div>
                    <span>Delivered</span>
                </div>
            </div>

            <!-- Product Table -->
            <div class="product-table">
                <div class="table-header">
                    <div class="col-product">PRODUCT</div>
                    <div class="col-price">PRICE</div>
                    <div class="col-quantity">QUANTITY</div>
                    <div class="col-subtotal">SUBTOTAL</div>
                </div>

                <div id="order-items-list">
                    <!-- Sẽ được load động từ API -->
                    <div style="text-align: center; padding: 40px; color: #5a5a7a;">Đang tải sản phẩm...</div>
                </div>
            </div>

            <!-- Action Button -->
            <div class="action-section">
                <button class="continue-shopping-btn" onclick="window.location.href='/ClientSite/shop-grid.html'">Continue Shopping</button>
            </div>
        </div>
    </main>

    <!-- Footer - Dynamic -->
    <div id="site-footer"></div>

    <script src="/Assets/Components/layout.js" defer></script>
    <script>
        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Parse shipping address
        function parseShippingAddress(addressString) {
            if (!addressString) return null;
            
            // Address có thể là string hoặc array
            if (typeof addressString === 'string') {
                const parts = addressString.split(',').map(s => s.trim());
                return {
                    address: parts[0] || '',
                    city: parts[1] || '',
                    postal: parts[2] || ''
                };
            }
            return null;
        }

        // Update order status tracker
        function updateOrderStatusTracker(orderStatus) {
            const tracker = document.getElementById('order-status-tracker');
            if (!tracker) return;

            const steps = tracker.querySelectorAll('.status-step');
            steps.forEach(step => step.classList.remove('completed', 'current'));

            const statusMap = {
                'Pending': 'received',
                'Processing': 'processing',
                'Shipped': 'shipped',
                'Delivered': 'delivered',
                'Cancelled': 'received' // Cancelled orders stay at received
            };

            const currentStep = statusMap[orderStatus] || 'received';
            let foundCurrent = false;

            steps.forEach(step => {
                const stepName = step.getAttribute('data-step');
                if (stepName === currentStep) {
                    step.classList.add('current');
                    foundCurrent = true;
                } else if (!foundCurrent) {
                    step.classList.add('completed');
                }
            });
        }

        // Load order details từ API
        async function loadOrderDetails() {
            // Lấy order_no từ URL hoặc localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let orderNo = urlParams.get('order_no');
            
            // Nếu không có trong URL, thử lấy từ localStorage
            if (!orderNo) {
                // Thử từ phuclong_view_order_no
                orderNo = localStorage.getItem('phuclong_view_order_no');
                
                // Nếu vẫn không có, thử từ phuclong_current_order
                if (!orderNo) {
                    const currentOrder = JSON.parse(localStorage.getItem('phuclong_current_order') || 'null');
                    if (currentOrder && currentOrder.order_no) {
                        orderNo = currentOrder.order_no;
                    }
                }
            }

            if (!orderNo) {
                alert('Không tìm thấy mã đơn hàng!');
                window.location.href = '/ClientSite/my-orders.html';
                return;
            }
            
            console.log('Loading order with order_no:', orderNo);

            try {
                const response = await fetch(`/api/orders/${encodeURIComponent(orderNo)}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        alert('Không tìm thấy đơn hàng!');
                        window.location.href = '/ClientSite/my-orders.html';
                        return;
                    }
                    throw new Error('Lỗi khi tải đơn hàng');
                }

                const order = await response.json();

                // Cập nhật page title
                const orderDate = formatDate(order.created_at);
                const itemsCount = order.items ? order.items.length : 0;
                document.getElementById('order-title').textContent = 
                    `Order Details • ${orderDate} • ${itemsCount} Products`;

                // Cập nhật order ID và payment method
                document.getElementById('order-id').textContent = `ORDER ID: #${order.order_no}`;
                
                // Lấy payment_method từ order hoặc localStorage
                let paymentMethod = order.payment_method;
                if (!paymentMethod) {
                    // Thử lấy từ localStorage (nếu có)
                    const savedOrder = JSON.parse(localStorage.getItem('phuclong_current_order') || 'null');
                    if (savedOrder && savedOrder.order_no === order.order_no) {
                        paymentMethod = savedOrder.payment_method;
                    }
                }
                
                const paymentMethodText = paymentMethod ? {
                    'cash': 'Tiền mặt (COD)',
                    'momo': 'Ví MoMo',
                    'vnpay': 'VNPay'
                }[paymentMethod.toLowerCase()] || paymentMethod : 'Chưa xác định';
                document.getElementById('payment-method').textContent = `PAYMENT METHOD: ${paymentMethodText}`;

                // Cập nhật totals
                const subtotal = order.subtotal || 0;
                const shipping = order.shipping_fee || 30000;
                const total = order.total_amount || (subtotal + shipping);
                
                document.getElementById('order-subtotal').textContent = formatPrice(subtotal);
                document.getElementById('order-shipping').textContent = formatPrice(shipping);
                document.getElementById('order-total').textContent = formatPrice(total);

                // Cập nhật shipping address
                // Lấy shipping info từ localStorage nếu có
                const shippingInfo = JSON.parse(localStorage.getItem('phuclong_shipping_info') || 'null');
                const currentUser = JSON.parse(localStorage.getItem('phuclong_current_user') || 'null');
                
                let userName = currentUser ? (currentUser.name || currentUser.email || 'User') : 'User';
                let userEmail = currentUser ? (currentUser.email || '') : '';
                
                // Ưu tiên dùng shipping info từ localStorage, sau đó mới dùng từ order
                let addressHtml = '';
                if (shippingInfo && (shippingInfo.first_name || shippingInfo.last_name || shippingInfo.address)) {
                    const fullName = [shippingInfo.first_name, shippingInfo.last_name].filter(Boolean).join(' ') || userName;
                    addressHtml = `
                        <p><strong>${fullName}</strong></p>
                        ${shippingInfo.address ? `<p>${shippingInfo.address}</p>` : ''}
                        ${shippingInfo.apartment ? `<p>${shippingInfo.apartment}</p>` : ''}
                        ${shippingInfo.city ? `<p>${shippingInfo.city}</p>` : ''}
                        ${shippingInfo.country ? `<p>${shippingInfo.country}</p>` : ''}
                        ${shippingInfo.postal_code ? `<p>${shippingInfo.postal_code}</p>` : ''}
                        ${shippingInfo.email || userEmail ? `<p>${shippingInfo.email || userEmail}</p>` : ''}
                    `;
                } else {
                    // Fallback: dùng từ order.shipping_address
                    const shippingAddr = parseShippingAddress(order.shipping_address);
                    addressHtml = shippingAddr ? `
                        <p><strong>${userName}</strong></p>
                        <p>${shippingAddr.address}</p>
                        ${shippingAddr.city ? `<p>${shippingAddr.city}</p>` : ''}
                        ${shippingAddr.postal ? `<p>${shippingAddr.postal}</p>` : ''}
                        ${userEmail ? `<p>${userEmail}</p>` : ''}
                    ` : `
                        <p><strong>${userName}</strong></p>
                        <p>${order.shipping_address || 'Chưa có địa chỉ'}</p>
                        ${userEmail ? `<p>${userEmail}</p>` : ''}
                    `;
                }
                
                document.getElementById('shipping-address').innerHTML = addressHtml;
                document.getElementById('billing-address').innerHTML = addressHtml; // Billing = Shipping for now

                // Cập nhật order status tracker
                updateOrderStatusTracker(order.order_status || 'Pending');

                // Render order items
                const itemsListEl = document.getElementById('order-items-list');
                if (order.items && order.items.length > 0) {
                    itemsListEl.innerHTML = order.items.map(item => {
                        const unitPrice = item.unit_price || 0;
                        const quantity = item.quantity || 1;
                        const lineTotal = item.line_total || (unitPrice * quantity);
                        
                        // Tìm image từ product (nếu có)
                        const productImage = item.image || '/Assets/images/LogoPhucLong.png';
                        let imageSrc = productImage;
                        if (!productImage.startsWith('http://') && !productImage.startsWith('https://')) {
                            if (productImage.startsWith('/')) {
                                imageSrc = productImage;
                            } else {
                                imageSrc = '/Assets/images/' + productImage;
                            }
                        }

                        return `
                            <div class="product-item">
                                <div class="product-details">
                                    <div class="product-image">
                                        <img src="${imageSrc}" alt="${item.product_name || 'Product'}" onerror="this.src='/Assets/images/LogoPhucLong.png'">
                                    </div>
                                    <div class="product-info">
                                        <h3>${item.product_name || 'Sản phẩm'}</h3>
                                    </div>
                                </div>
                                <div class="product-price">${formatPrice(unitPrice)}</div>
                                <div class="product-quantity">x${quantity}</div>
                                <div class="product-subtotal">${formatPrice(lineTotal)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    itemsListEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #5a5a7a;">Không có sản phẩm nào</div>';
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('Lỗi khi tải thông tin đơn hàng. Vui lòng thử lại.');
            }
        }

        // Load order details khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            // Đợi header/footer load xong
            document.addEventListener('phuclong:hf-loaded', function() {
                loadOrderDetails();
            });

            // Fallback nếu event không fire
            setTimeout(() => {
                loadOrderDetails();
            }, 500);
        });
    </script>
</body>
</html>



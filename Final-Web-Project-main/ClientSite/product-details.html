<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Phuc Long - Product Details</title>

  <link rel="stylesheet" href="/Assets/CSS/product-details.css" />
  <link rel="stylesheet" href="/Assets/Components/header-footer.css" />
  <style>
    /* Voucher Dropdown Styles */
    .voucher-dropdown summary {
      list-style: none;
    }
    .voucher-dropdown summary::-webkit-details-marker {
      display: none;
    }
    .voucher-dropdown summary::marker {
      display: none;
    }
    /* Ch·ªâ rotate m≈©i t√™n, kh√¥ng rotate to√†n b·ªô summary */
    .voucher-dropdown[open] summary .arrow-icon {
      transform: rotate(180deg);
      transition: transform 0.3s;
    }
    .voucher-dropdown summary .arrow-icon {
      transition: transform 0.3s;
      display: inline-block;
    }
  </style>
</head>
<body>

  <!-- Header inject -->
  <div id="site-header"></div>

  <!-- PAGE HERO / BREADCRUMB -->
  <section class="page-hero">
    <div class="page-hero-inner">
      <h1 class="page-title">Product Details</h1>
      <div class="breadcrumb">
        Home . Pages . <span>Product Details</span>
      </div>
    </div>
  </section>

  <!-- PRODUCT TOP INFO -->
  <section class="product-hero">
    <div class="product-hero-inner">
      <div class="product-hero-card">

        <!-- IMAGE LEFT -->
        <div class="product-main-image">
          <img id="product-main-image" src="/Assets/images/LogoPhucLong.png" alt="Product" />
        </div>

        <!-- INFO RIGHT -->
        <div class="product-main-info">
          <h2 class="product-name" id="product-name">Loading...</h2>

          <div class="product-rating-line">
            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
            <span class="review-count">2792</span>
          </div>

          <!-- Price display (size selector ƒë√£ ·∫©n) -->
          <div class="product-price-display" id="product-price-display" style="margin: 20px 0; font-size: 24px; font-weight: bold; color: #fb2e86;">
            <span id="display-price">ƒêang t·∫£i...</span>
            <span id="discounted-price" style="display: none; color: #28a745; margin-left: 10px;"></span>
            <span id="voucher-applied-badge" style="display: none; margin-left: 10px; padding: 4px 8px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: normal;">
              üéüÔ∏è ƒê√£ √°p d·ª•ng voucher: <span id="applied-voucher-code-display"></span>
              <button onclick="removeAppliedVoucher()" style="
                margin-left: 8px;
                background: rgba(255,255,255,0.3);
                color: white;
                border: 1px solid white;
                padding: 2px 6px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 11px;
              ">‚úï</button>
            </span>
          </div>
          <input type="hidden" id="selected-size" value="">
          <input type="hidden" id="selected-price" value="">

          <!-- Voucher Section - Dropdown -->
          <details class="voucher-dropdown" id="voucher-dropdown" style="margin: 20px 0; display: none;">
            <summary style="
              padding: 12px 16px;
              background: #f8f9fa;
              border: 1px solid #ddd;
              border-radius: 8px;
              cursor: pointer;
              font-weight: 600;
              color: #333;
              list-style: none;
              user-select: none;
            ">
              <span style="display: flex; align-items: center; justify-content: space-between;">
                <span>üéüÔ∏è Voucher kh·∫£ d·ª•ng (<span id="voucher-count">0</span>)</span>
                <span class="arrow-icon" style="font-size: 12px; color: #666;">‚ñº</span>
              </span>
            </summary>
            <div id="voucher-list" style="
              margin-top: 10px;
              padding: 15px;
              background: white;
              border: 1px solid #ddd;
              border-radius: 8px;
              display: flex;
              flex-direction: column;
              gap: 8px;
              max-height: 300px;
              overflow-y: auto;
            ">
              <!-- Vouchers will be loaded here -->
            </div>
          </details>

          <!-- short description -->
          <div class="short-desc" id="product-description">
            ƒêang t·∫£i m√¥ t·∫£ s·∫£n ph·∫©m...
          </div>

          <!-- actions -->
          <div class="buy-row">
            <a href="#" class="btn-buy" onclick="buyNow(); return false;">MUA NGAY</a>
            <button class="btn-add-cart" onclick="addToCartFromProductPage()">TH√äM V√ÄO GI·ªé H√ÄNG</button>

            <div class="share-row">
              <span class="share-label">Chia s·∫ª</span>
              <button class="like-btn" title="Y√™u th√≠ch">‚ô°</button>
              <a class="share-icon fb" href="#" aria-label="Facebook">f</a>
              <a class="share-icon ig" href="#" aria-label="Instagram">‚óé</a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- PRODUCT TABS / DESCRIPTION -->
  <section class="product-tabs-section">
    <div class="tabs-inner">

      <div class="tabs-header">
        <a class="tab-link active" href="#">Description</a>
        <a class="tab-link" href="#">Information</a>
        <a class="tab-link" href="#">Reviews</a>
      </div>

      <div class="tabs-body">
        <p>
          Pomegranate Black Tea is an elegant combination of bold black tea and the
          gentle sweetness of pomegranate, bringing a sense of freshness and sophistication.
        </p>
        <p>
          The smooth foam with a hint of pomegranate aroma adds a charming decorative
          touch, perfect for those who love delicate scents and want to ‚Äúlift their mood‚Äù
          every day.
        </p>
        <p>
          This drink not only quenches your thirst but also brings a sense of relaxation
          and refreshment with every sip. With its vibrant red hue and harmonious balance
          between tea and fruit flavor, it‚Äôs the perfect choice for a quick summer break
          or whenever you need a little inspiration during the day.
        </p>
      </div>

    </div>
  </section>

  <!-- RECOMMENDATIONS -->
  <section class="recs-section">
    <div class="recs-inner">
      <h3 class="recs-title">Recommendations</h3>

      <div class="recs-grid" id="recommendations-grid">
        <!-- S·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ API -->
        <div style="text-align: center; padding: 40px; color: #5a5a7a; grid-column: 1 / -1;">ƒêang t·∫£i s·∫£n ph·∫©m ƒë·ªÅ xu·∫•t...</div>
      </div>
    </div>
  </section>

  <!-- Footer - Dynamic -->
  <div id="site-footer"></div>
  
  <script src="/Assets/Components/layout.js" defer></script>

  <!-- Include cart manager -->
  <script src="../Assets/JS/cart-manager.js"></script>
  
  <script>
    // L·∫•y user_id v√† session_id
    function getCartIdentifiers() {
      const currentUser = JSON.parse(localStorage.getItem('phuclong_current_user') || 'null');
      const sessionId = localStorage.getItem('phuclong_session_id') || null;
      
      return {
        user_id: currentUser ? (currentUser.id || currentUser._id) : null,
        session_id: sessionId
      };
    }
    
    // T·∫°o ho·∫∑c l·∫•y session_id
    function getOrCreateSessionId() {
      let sessionId = localStorage.getItem('phuclong_session_id');
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('phuclong_session_id', sessionId);
      }
      return sessionId;
    }
    
    // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
    async function checkProductInCart(productId) {
      try {
        const { user_id, session_id } = getCartIdentifiers();
        const sessionId = session_id || localStorage.getItem('phuclong_session_id');
        
        let apiUrl = '/api/carts?';
        if (user_id) {
          apiUrl += `user_id=${encodeURIComponent(user_id)}`;
        } else if (sessionId) {
          apiUrl += `session_id=${encodeURIComponent(sessionId)}`;
        }
        
        const response = await fetch(apiUrl);
        const result = await response.json();
        
        if (result.data && result.data.items) {
          const found = result.data.items.find(item => {
            const itemProductId = item.product_id || item.id;
            if (typeof itemProductId === 'object' && itemProductId.toString) {
              return itemProductId.toString() === productId;
            }
            return String(itemProductId) === String(productId);
          });
          return !!found;
        }
        return false;
      } catch (error) {
        console.error('Error checking cart:', error);
        return false;
      }
    }
    
    // H√†m th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng t·ª´ trang product details - G·ªåI API
    async function addToCartFromProductPage() {
      // ƒê·ªçc th√¥ng tin s·∫£n ph·∫©m t·ª´ localStorage
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      
      if (!productData.id) {
        // Fallback n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
        productData.id = 'tra-ba-tuoc-luu-do';
        productData.name = 'Tr√† b√° t∆∞·ªõc l·ª±u ƒë·ªè';
        productData.price = 55000;
        productData.image = 'Tr√† th∆°m ƒë·∫≠m v·ªã/TraBaTuocLuuDo.png';
      }
      
      // L·∫•y price t·ª´ product (kh√¥ng c·∫ßn size)
      const price = getProductPrice();
      const productName = productData.name || 'S·∫£n ph·∫©m';
      
      try {
        // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
        const alreadyInCart = await checkProductInCart(productData.id);
        if (alreadyInCart) {
          alert(`${productName} ƒë√£ c√≥ trong gi·ªè h√†ng c·ªßa b·∫°n`);
          return;
        }
        
        const { user_id, session_id } = getCartIdentifiers();
        const sessionId = session_id || getOrCreateSessionId();
        
        // G·ªçi API ƒë·ªÉ th√™m v√†o gi·ªè h√†ng
        const formData = new FormData();
        formData.append('product_id', productData.id);
        formData.append('product_name', productName);
        formData.append('price', String(price));
        formData.append('quantity', '1');
        if (productData.image) {
          formData.append('image', productData.image);
        }
        if (user_id) {
          formData.append('user_id', user_id);
        }
        if (sessionId) {
          formData.append('session_id', sessionId);
          localStorage.setItem('phuclong_session_id', sessionId);
        }
        
        const response = await fetch('/api/carts', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // C·∫≠p nh·∫≠t LocalStorage cart ƒë·ªÉ sync
          if (typeof addToCart === 'function') {
            addToCart(productData.id, productName, price, productData.image);
          } else {
            // Fallback: th√¥ng b√°o th√†nh c√¥ng
            alert(`ƒê√£ th√™m "${productName}" v√†o gi·ªè h√†ng!`);
          }
        } else {
          alert(result.detail || 'L·ªói khi th√™m v√†o gi·ªè h√†ng');
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        // Fallback: g·ªçi h√†m addToCart t·ª´ cart-manager.js
        if (typeof addToCart === 'function') {
          addToCart(productData.id, productName, price, productData.image);
        } else {
          alert('L·ªói khi th√™m v√†o gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      }
    }

    // H√†m ch·ªçn size
    function selectSize(size, price) {
      // X√≥a selected class t·ª´ t·∫•t c·∫£ size boxes
      document.querySelectorAll('.size-box').forEach(box => {
        box.classList.remove('selected');
      });
      
      // Th√™m selected class cho size ƒë∆∞·ª£c ch·ªçn
      const selectedBox = document.querySelector(`.size-box[data-size="${size}"]`);
      if (selectedBox) {
        selectedBox.classList.add('selected');
      }
      
      // L∆∞u size v√† price ƒë√£ ch·ªçn
      document.getElementById('selected-size').value = size;
      document.getElementById('selected-price').value = price;
      
      // C·∫≠p nh·∫≠t localStorage
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      productData.selectedSize = size;
      productData.selectedPrice = price;
      localStorage.setItem('phuclong_current_product', JSON.stringify(productData));
    }
    
    // H√†m l·∫•y price t·ª´ product (kh√¥ng c·∫ßn size n·ªØa)
    function getProductPrice() {
      // L·∫•y gi√° t·ª´ product data ho·∫∑c t·ª´ hidden input
      const priceInput = document.getElementById('selected-price');
      if (priceInput && priceInput.value) {
        return parseFloat(priceInput.value);
      }
      
      // Fallback: l·∫•y t·ª´ localStorage ho·∫∑c gi√° m·∫∑c ƒë·ªãnh
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      return productData.price || 0;
    }
    
    // H√†m chuy·ªÉn ƒë·∫øn gi·ªè h√†ng
    function goToCart() {
      window.location.href = '../ClientSite/shopping-cart.html';
    }
    
    // H√†m Mua ngay - chuy·ªÉn th·∫≥ng ƒë·∫øn checkout
    async function buyNow() {
      // ƒê·ªçc th√¥ng tin s·∫£n ph·∫©m t·ª´ localStorage
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      
      if (!productData.id) {
        // Fallback n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
        productData.id = 'tra-ba-tuoc-luu-do';
        productData.name = 'Tr√† b√° t∆∞·ªõc l·ª±u ƒë·ªè';
        productData.price = 55000;
        productData.image = 'Tr√† th∆°m ƒë·∫≠m v·ªã/TraBaTuocLuuDo.png';
      }
      
      // L·∫•y price t·ª´ product (kh√¥ng c·∫ßn size)
      const price = getProductPrice();
      
      try {
        // ƒê·∫£m b·∫£o _id ƒë∆∞·ª£c l·∫•y ƒë√∫ng (MongoDB ObjectId)
        // ∆Øu ti√™n _id, sau ƒë√≥ product_id, cu·ªëi c√πng l√† id
        const productId = productData._id || productData.product_id || productData.id;
        
        // T·∫°o checkout item t·ª´ s·∫£n ph·∫©m hi·ªán t·∫°i
        const checkoutItem = {
          id: productData.id || productId, // SKU ho·∫∑c ID
          _id: productId, // MongoDB _id (quan tr·ªçng nh·∫•t ƒë·ªÉ so s√°nh v·ªõi voucher)
          product_id: productId, // Alias cho product_id
          name: productData.name || 'S·∫£n ph·∫©m',
          price: price,
          quantity: 1,
          image: productData.image || ''
        };
        
        console.log('Checkout item created:', checkoutItem);
        
        // L∆∞u v√†o localStorage ƒë·ªÉ checkout-shipping.html load
        localStorage.setItem('phuclong_checkout_items', JSON.stringify([checkoutItem]));
        
        // Th√™m v√†o cart API (ƒë·ªÉ ƒë·ªìng b·ªô)
        const { user_id, session_id } = getCartIdentifiers();
        const sessionId = session_id || getOrCreateSessionId();
        
        const formData = new FormData();
        formData.append('product_id', productData.id);
        formData.append('product_name', productData.name || 'S·∫£n ph·∫©m');
        formData.append('price', String(price));
        formData.append('quantity', '1');
        if (productData.image) {
          formData.append('image', productData.image);
        }
        if (user_id) {
          formData.append('user_id', user_id);
        }
        if (sessionId) {
          formData.append('session_id', sessionId);
          localStorage.setItem('phuclong_session_id', sessionId);
        }
        
        // G·ªçi API ƒë·ªÉ th√™m v√†o cart (kh√¥ng c·∫ßn ƒë·ª£i response)
        fetch('/api/carts', {
          method: 'POST',
          body: formData
        }).catch(err => {
          console.error('Error adding to cart:', err);
          // V·∫´n ti·∫øp t·ª•c chuy·ªÉn ƒë·∫øn checkout d√π API l·ªói
        });
        
        // Chuy·ªÉn ƒë·∫øn trang checkout-shipping
        window.location.href = '/ClientSite/checkout-shipping.html';
      } catch (error) {
        console.error('Error in buyNow:', error);
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi trang load
    function updateLoginStatus() {
      const isLoggedIn = localStorage.getItem('phuclong_user_logged_in') === 'true';
      const loginStatus = document.getElementById('loginStatus');
      
      if (loginStatus) {
        loginStatus.textContent = isLoggedIn ? 'Logoutüë§' : 'Loginüë§';
      }
    }

    // Load product data t·ª´ URL ho·∫∑c localStorage
    async function loadProductData() {
      console.log('loadProductData called');
      // L·∫•y SKU t·ª´ URL
      const urlParams = new URLSearchParams(window.location.search);
      const sku = urlParams.get('sku');
      
      console.log('SKU from URL:', sku);
      
      if (sku) {
        try {
          console.log('Fetching product from API...');
          // Fetch product t·ª´ API b·∫±ng SKU (s·ª≠ d·ª•ng endpoint /api/products/{sku})
          const response = await fetch(`/api/products/${encodeURIComponent(sku)}`);
          
          console.log('API Response status:', response.status);
          
          if (response.ok) {
            const product = await response.json();
            console.log('Product data received:', product);
            displayProduct(product);
            
            // L∆∞u v√†o localStorage ƒë·ªÉ addToCart s·ª≠ d·ª•ng
            localStorage.setItem('phuclong_current_product', JSON.stringify({
              id: product.sku || product._id,
              _id: product._id, // L∆∞u MongoDB _id ƒë·ªÉ so s√°nh v·ªõi voucher applicable_product_ids
              product_id: product._id, // Alias cho product_id
              name: product.name,
              price: product.price || 0,
              image: (product.images && product.images.length > 0) ? product.images[0] : '',
              description: product.description || '',
              stock_quantity: product.stock_quantity || 0
            }));
            
            // Load sizes t·ª´ product data n·∫øu c√≥
            loadSizesFromProduct(product);
            
            // Load recommendations sau khi ƒë√£ load product
            setTimeout(() => {
              loadRecommendations(product.sku || product._id);
            }, 200);
          } else {
            // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m trong danh s√°ch products
            console.warn(`Product with SKU ${sku} not found, trying search...`);
            const searchResponse = await fetch(`/api/products?pageSize=500`);
            const searchResult = await searchResponse.json();
            
            if (searchResult.data) {
              const foundProduct = searchResult.data.find(p => 
                (p.sku && p.sku === sku) || 
                (p._id && String(p._id) === sku)
              );
              
              if (foundProduct) {
                displayProduct(foundProduct);
                localStorage.setItem('phuclong_current_product', JSON.stringify({
                  id: foundProduct.sku || foundProduct._id,
                  name: foundProduct.name,
                  price: foundProduct.price || 0,
                  image: (foundProduct.images && foundProduct.images.length > 0) ? foundProduct.images[0] : '',
                  description: foundProduct.description || '',
                  stock_quantity: foundProduct.stock_quantity || 0
                }));
                loadSizesFromProduct(foundProduct);
                return;
              }
            }
            
            // Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m
            console.error(`Product with SKU ${sku} not found`);
            alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
          }
        } catch (error) {
          console.error('Error loading product:', error);
          alert('L·ªói khi t·∫£i th√¥ng tin s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      } else {
        // Kh√¥ng c√≥ SKU trong URL
        console.warn('No SKU in URL');
        
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        const nameEl = document.getElementById('product-name');
        const priceEl = document.getElementById('display-price');
        const descEl = document.getElementById('product-description');
        
        if (nameEl) {
          nameEl.textContent = 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m';
        }
        if (priceEl) {
          priceEl.textContent = 'Vui l√≤ng ch·ªçn s·∫£n ph·∫©m t·ª´ danh s√°ch';
        }
        if (descEl) {
          descEl.textContent = 'Kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m. Vui l√≤ng quay l·∫°i trang danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ ch·ªçn s·∫£n ph·∫©m.';
        }
      }
    }
    
    // Load sizes t·ª´ product data
    function loadSizesFromProduct(product) {
      // N·∫øu product c√≥ th√¥ng tin v·ªÅ sizes/variants, load v√†o size selector
      // Hi·ªán t·∫°i gi·ªØ nguy√™n M v√† L v·ªõi gi√° m·∫∑c ƒë·ªãnh
      // C√≥ th·ªÉ m·ªü r·ªông sau n·∫øu API tr·∫£ v·ªÅ sizes
      if (product.priceMin && product.priceMax) {
        // C√≥ th·ªÉ c√≥ nhi·ªÅu size v·ªõi gi√° kh√°c nhau
        // T·∫°m th·ªùi gi·ªØ nguy√™n logic hi·ªán t·∫°i
      }
    }
    
    // Load product t·ª´ localStorage
    function loadProductFromLocalStorage() {
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      if (productData.id) {
        displayProduct({
          name: productData.name || 'Product',
          price: productData.price || 0,
          images: productData.image ? [productData.image] : []
        });
      }
    }
    
    // Hi·ªÉn th·ªã product data
    function displayProduct(product) {
      console.log('displayProduct called with:', product);
      
      // C·∫≠p nh·∫≠t t√™n
      const nameEl = document.getElementById('product-name');
      if (nameEl) {
        nameEl.textContent = product.name || 'Product';
        console.log('Product name updated:', product.name);
      } else {
        console.error('product-name element not found!');
      }
      
      // C·∫≠p nh·∫≠t gi√° (kh√¥ng hi·ªÉn th·ªã size)
      const priceEl = document.getElementById('display-price');
      const priceInput = document.getElementById('selected-price');
      const productPrice = product.price || 0;
      
      console.log('Product price:', productPrice);
      
      if (priceEl) {
        priceEl.textContent = formatPrice(productPrice);
        priceEl.style.textDecoration = 'none';
        priceEl.style.color = '#fb2e86';
        console.log('Price updated to:', formatPrice(productPrice));
      } else {
        console.error('display-price element not found!');
      }
      
      if (priceInput) {
        priceInput.value = productPrice;
      }
      
      // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng t·ª´ tr∆∞·ªõc
      const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
      const appliedVoucherData = localStorage.getItem('phuclong_selected_voucher_data');
      if (appliedVoucher && appliedVoucherData) {
        try {
          const voucher = JSON.parse(appliedVoucherData);
          // Ki·ªÉm tra xem voucher c√≥ √°p d·ª•ng cho s·∫£n ph·∫©m n√†y kh√¥ng
          const productId = String(product._id || product.id || '');
          let canApply = true;
          
          if (voucher.applicable_product_ids && voucher.applicable_product_ids.length > 0) {
            const applicableIds = voucher.applicable_product_ids.map(id => String(id));
            canApply = applicableIds.includes(productId);
          }
          
          if (canApply && voucher.min_order_value <= productPrice) {
            // √Åp d·ª•ng l·∫°i voucher
            let discountedPrice = productPrice;
            if (voucher.type === 'percent') {
              discountedPrice = productPrice * (1 - voucher.value / 100);
            } else if (voucher.type === 'fixed') {
              discountedPrice = Math.max(0, productPrice - voucher.value);
            }
            
            // Hi·ªÉn th·ªã gi√° ƒë√£ gi·∫£m
            const discountedEl = document.getElementById('discounted-price');
            const voucherBadge = document.getElementById('voucher-applied-badge');
            const voucherCodeDisplay = document.getElementById('applied-voucher-code-display');
            
            if (discountedEl && priceEl) {
              priceEl.style.textDecoration = 'line-through';
              priceEl.style.color = '#999';
              discountedEl.style.display = 'inline';
              discountedEl.textContent = formatPrice(discountedPrice);
            }
            
            if (voucherBadge && voucherCodeDisplay) {
              voucherCodeDisplay.textContent = appliedVoucher;
              voucherBadge.style.display = 'inline-block';
            }
          } else {
            // Voucher kh√¥ng √°p d·ª•ng cho s·∫£n ph·∫©m n√†y, x√≥a
            localStorage.removeItem('phuclong_selected_voucher');
            localStorage.removeItem('phuclong_selected_voucher_data');
          }
        } catch (e) {
          console.error('Error checking applied voucher:', e);
        }
      }
      
      // C·∫≠p nh·∫≠t m√¥ t·∫£ s·∫£n ph·∫©m
      const descEl = document.getElementById('product-description');
      if (descEl) {
        // L·∫•y description t·ª´ product object (kh√¥ng ph·∫£i t·ª´ localStorage)
        let description = product.description;
        
        console.log('Raw description from product:', description);
        console.log('Product name:', product.name);
        console.log('Product SKU/ID:', product.sku || product._id || product.id);
        
        // N·∫øu description l√† HTML, l·∫•y text thu·∫ßn
        if (description && typeof description === 'string') {
          // T·∫°o m·ªôt element t·∫°m ƒë·ªÉ l·∫•y text t·ª´ HTML
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = description;
          const textContent = tempDiv.textContent || tempDiv.innerText || '';
          
          // N·∫øu sau khi l·∫•y text t·ª´ HTML m√† v·∫´n c√≥ n·ªôi dung, d√πng n√≥
          if (textContent.trim() !== '') {
            description = textContent.trim();
          } else {
            // N·∫øu kh√¥ng c√≥ text, ki·ªÉm tra xem c√≥ ph·∫£i l√† HTML tags tr·ªëng kh√¥ng
            const stripped = description.replace(/<[^>]*>/g, '').trim();
            if (stripped === '') {
              description = null; // ƒê√°nh d·∫•u l√† r·ªóng
            } else {
              description = stripped;
            }
          }
        }
        
        // Ki·ªÉm tra n·∫øu description r·ªóng ho·∫∑c kh√¥ng c√≥, d√πng t√™n s·∫£n ph·∫©m
        if (!description || 
            description.trim() === '' || 
            description.trim() === '<p><br></p>' || 
            description.trim() === '<br>' ||
            description.trim() === '<p></p>') {
          // D√πng t√™n s·∫£n ph·∫©m thay v√¨ description
          description = product.name || 'S·∫£n ph·∫©m';
          console.log('Using product name as description:', description);
        }
        
        descEl.textContent = description;
        console.log('Final description displayed:', description);
      } else {
        console.error('product-description element not found!');
      }
      
      // C·∫≠p nh·∫≠t h√¨nh ·∫£nh
      const imageEl = document.getElementById('product-main-image');
      if (imageEl && product.images && product.images.length > 0) {
        const imagePath = product.images[0];
        
        // X·ª≠ l√Ω image path: n·∫øu ƒë√£ l√† full URL (http/https) th√¨ d√πng tr·ª±c ti·∫øp
        let imageSrc = '';
        if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
          imageSrc = imagePath;
        } else if (imagePath.startsWith('/')) {
          imageSrc = imagePath;
        } else if (imagePath) {
          imageSrc = `/Assets/images/${imagePath}`;
        } else {
          imageSrc = '/Assets/images/LogoPhucLong.png';
        }
        
        imageEl.src = imageSrc;
        imageEl.alt = product.name || 'Product';
        imageEl.onerror = function() {
          this.src = '/Assets/images/LogoPhucLong.png';
        };
      }
      
      // Load vouchers sau khi hi·ªÉn th·ªã product
      loadVouchersForProduct(product);
    }
    
    // Load vouchers cho s·∫£n ph·∫©m
    async function loadVouchersForProduct(product) {
      const voucherSection = document.getElementById('voucher-dropdown');
      const voucherList = document.getElementById('voucher-list');
      
      if (!voucherSection || !voucherList) return;
      
      try {
        // Load t·∫•t c·∫£ vouchers active
        const response = await fetch(`/api/vouchers?status_q=active&pageSize=50`);
        const result = await response.json();
        
        if (!result.data || result.data.length === 0) {
          voucherSection.style.display = 'none';
          return;
        }
        
        // L·ªçc vouchers c√≥ th·ªÉ √°p d·ª•ng cho s·∫£n ph·∫©m n√†y
        // L·∫•y product ID t·ª´ _id (MongoDB ObjectId) ho·∫∑c id
        const productId = String(product._id || product.id || '');
        const productPrice = product.price || 0;
        const now = new Date();
        
        const applicableVouchers = result.data.filter(voucher => {
          // Ki·ªÉm tra status
          if (voucher.status !== 'active') return false;
          
          // Ki·ªÉm tra th·ªùi gian hi·ªáu l·ª±c
          if (voucher.start_at) {
            const startAt = new Date(voucher.start_at);
            if (now < startAt) return false;
          }
          if (voucher.end_at) {
            const endAt = new Date(voucher.end_at);
            if (now > endAt) return false;
          }
          
          // Ki·ªÉm tra applicable_product_ids
          // N·∫øu voucher c√≥ applicable_product_ids, s·∫£n ph·∫©m ph·∫£i n·∫±m trong danh s√°ch
          if (voucher.applicable_product_ids && Array.isArray(voucher.applicable_product_ids) && voucher.applicable_product_ids.length > 0) {
            // Convert t·∫•t c·∫£ IDs sang string ƒë·ªÉ so s√°nh
            const applicableIds = voucher.applicable_product_ids.map(id => String(id));
            if (!applicableIds.includes(productId)) {
              return false; // S·∫£n ph·∫©m kh√¥ng n·∫±m trong danh s√°ch √°p d·ª•ng
            }
          }
          // N·∫øu kh√¥ng c√≥ applicable_product_ids ho·∫∑c l√† empty array, voucher √°p d·ª•ng cho t·∫•t c·∫£ s·∫£n ph·∫©m
          
          // Ki·ªÉm tra min_order_value
          if (voucher.min_order_value && voucher.min_order_value > 0) {
            if (productPrice < voucher.min_order_value) return false;
          }
          
          return true;
        });
        
        if (applicableVouchers.length > 0) {
          voucherList.innerHTML = '';
          
          // Update voucher count
          const voucherCount = document.getElementById('voucher-count');
          if (voucherCount) voucherCount.textContent = applicableVouchers.length;
          
          // Ki·ªÉm tra voucher ƒë√£ √°p d·ª•ng
          const appliedVoucher = localStorage.getItem('phuclong_selected_voucher');
          const appliedVoucherData = localStorage.getItem('phuclong_selected_voucher_data');
          let appliedVoucherObj = null;
          if (appliedVoucherData) {
            try {
              appliedVoucherObj = JSON.parse(appliedVoucherData);
            } catch (e) {
              console.error('Error parsing applied voucher:', e);
            }
          }
          
          applicableVouchers.forEach(voucher => {
            // Ki·ªÉm tra xem voucher n√†y c√≥ ƒëang ƒë∆∞·ª£c √°p d·ª•ng kh√¥ng
            const isApplied = appliedVoucher && appliedVoucher === voucher.code;
            
            const voucherCard = document.createElement('div');
            
            // N·∫øu voucher ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng, d√πng n·ªÅn xanh l√°
            if (isApplied) {
              voucherCard.style.cssText = 'padding: 10px; background: #d4edda; border: 2px solid #28a745; border-radius: 6px; cursor: pointer; transition: all 0.3s;';
            } else {
              voucherCard.style.cssText = 'padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.3s;';
            }
            
            voucherCard.onmouseover = () => {
              if (!isApplied) {
                voucherCard.style.borderColor = '#fb2e86';
                voucherCard.style.background = '#fff';
              }
            };
            voucherCard.onmouseout = () => {
              if (isApplied) {
                voucherCard.style.borderColor = '#28a745';
                voucherCard.style.background = '#d4edda';
              } else {
                voucherCard.style.borderColor = '#ddd';
                voucherCard.style.background = '#f8f9fa';
              }
            };
            
            const discountText = voucher.type === 'percent' 
              ? `Gi·∫£m ${voucher.value}%` 
              : `Gi·∫£m ${formatPrice(voucher.value)}`;
            
            // T·∫°o elements b·∫±ng DOM thay v√¨ innerHTML ƒë·ªÉ tr√°nh l·ªói
            const cardContent = document.createElement('div');
            cardContent.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
            
            const leftDiv = document.createElement('div');
            
            const codeStrong = document.createElement('strong');
            codeStrong.style.color = isApplied ? '#155724' : '#fb2e86';
            codeStrong.textContent = voucher.code;
            leftDiv.appendChild(codeStrong);
            
            const discountDiv = document.createElement('div');
            discountDiv.style.cssText = 'font-size: 14px; color: #666; margin-top: 4px;';
            discountDiv.textContent = discountText;
            leftDiv.appendChild(discountDiv);
            
            // Hi·ªÉn th·ªã "ƒê√£ √°p d·ª•ng" n·∫øu voucher ƒëang ƒë∆∞·ª£c √°p d·ª•ng
            if (isApplied) {
              const appliedLabel = document.createElement('div');
              appliedLabel.style.cssText = 'font-size: 12px; color: #155724; margin-top: 4px; font-weight: 600;';
              appliedLabel.textContent = '‚úì ƒê√£ √°p d·ª•ng';
              leftDiv.appendChild(appliedLabel);
            }
            
            if (voucher.description) {
              const descDiv = document.createElement('div');
              descDiv.style.cssText = 'font-size: 12px; color: #999; margin-top: 2px;';
              descDiv.textContent = voucher.description;
              leftDiv.appendChild(descDiv);
            }
            
            if (voucher.min_order_value && voucher.min_order_value > 0) {
              const conditionDiv = document.createElement('div');
              conditionDiv.style.cssText = 'font-size: 11px; color: #ff9800; margin-top: 2px;';
              conditionDiv.textContent = `ƒê∆°n t·ªëi thi·ªÉu: ${formatPrice(voucher.min_order_value)}`;
              leftDiv.appendChild(conditionDiv);
            }
            
            // N·∫øu ƒë√£ √°p d·ª•ng, hi·ªÉn th·ªã n√∫t "H·ªßy √°p d·ª•ng" thay v√¨ "√Åp d·ª•ng"
            const applyBtn = document.createElement('button');
            if (isApplied) {
              applyBtn.textContent = 'H·ªßy √°p d·ª•ng';
              applyBtn.style.cssText = 'background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;';
              applyBtn.onclick = (e) => {
                e.stopPropagation();
                removeAppliedVoucher();
                // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI
                setTimeout(() => {
                  loadVouchersForProduct(product);
                }, 100);
              };
            } else {
              applyBtn.textContent = '√Åp d·ª•ng';
              applyBtn.style.cssText = 'background: #fb2e86; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;';
              applyBtn.onclick = (e) => {
                e.stopPropagation();
                applyVoucher(voucher.code, productPrice);
              };
            }
            
            cardContent.appendChild(leftDiv);
            cardContent.appendChild(applyBtn);
            voucherCard.appendChild(cardContent);
            voucherList.appendChild(voucherCard);
          });
          
          voucherSection.style.display = 'block';
        } else {
          voucherSection.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading vouchers:', error);
        voucherSection.style.display = 'none';
      }
    }
    
    // √Åp d·ª•ng voucher
    function applyVoucher(voucherCode, originalPrice) {
      // Load voucher details ƒë·ªÉ ki·ªÉm tra ƒëi·ªÅu ki·ªán v√† t√≠nh gi√° gi·∫£m
      fetch(`/api/vouchers/${voucherCode}`)
        .then(res => res.json())
        .then(voucher => {
          // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
          const now = new Date();
          
          // Ki·ªÉm tra status
          if (voucher.status !== 'active') {
            alert('Voucher kh√¥ng c√≤n hi·ªáu l·ª±c!');
            return;
          }
          
          // Ki·ªÉm tra th·ªùi gian hi·ªáu l·ª±c
          if (voucher.start_at) {
            const startAt = new Date(voucher.start_at);
            if (now < startAt) {
              alert('Voucher ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c!');
              return;
            }
          }
          if (voucher.end_at) {
            const endAt = new Date(voucher.end_at);
            if (now > endAt) {
              alert('Voucher ƒë√£ h·∫øt h·∫°n!');
              return;
            }
          }
          
          // Ki·ªÉm tra min_order_value
          if (voucher.min_order_value && voucher.min_order_value > 0) {
            if (originalPrice < voucher.min_order_value) {
              alert(`Voucher y√™u c·∫ßu ƒë∆°n h√†ng t·ªëi thi·ªÉu ${formatPrice(voucher.min_order_value)}!`);
              return;
            }
          }
          
          // T√≠nh gi√° gi·∫£m
          let discountedPrice = originalPrice;
          
          if (voucher.type === 'percent') {
            discountedPrice = originalPrice * (1 - voucher.value / 100);
          } else if (voucher.type === 'fixed') {
            discountedPrice = Math.max(0, originalPrice - voucher.value);
          }
          
          // L∆∞u voucher code v√†o localStorage
          localStorage.setItem('phuclong_selected_voucher', voucherCode);
          localStorage.setItem('phuclong_selected_voucher_data', JSON.stringify(voucher));
          
          // Hi·ªÉn th·ªã gi√° ƒë√£ gi·∫£m
          const discountedEl = document.getElementById('discounted-price');
          const priceEl = document.getElementById('display-price');
          const voucherBadge = document.getElementById('voucher-applied-badge');
          const voucherCodeDisplay = document.getElementById('applied-voucher-code-display');
          
          if (discountedEl && priceEl) {
            priceEl.style.textDecoration = 'line-through';
            priceEl.style.color = '#999';
            discountedEl.style.display = 'inline';
            discountedEl.textContent = formatPrice(discountedPrice);
          }
          
          // Hi·ªÉn th·ªã badge voucher ƒë√£ √°p d·ª•ng
          if (voucherBadge && voucherCodeDisplay) {
            voucherCodeDisplay.textContent = voucherCode;
            voucherBadge.style.display = 'inline-block';
          }
          
          // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI (highlight voucher ƒë√£ √°p d·ª•ng)
          const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
          const product = {
            _id: productData._id || productData.product_id,
            id: productData.id,
            price: productData.price || originalPrice
          };
          if (product._id || product.id) {
            setTimeout(() => {
              loadVouchersForProduct(product);
            }, 100);
          }
          
          // ƒê√≥ng dropdown n·∫øu ƒëang m·ªü
          const voucherDropdown = document.getElementById('voucher-dropdown');
          if (voucherDropdown && voucherDropdown.open) {
            voucherDropdown.open = false;
          }
          
          alert(`ƒê√£ √°p d·ª•ng voucher ${voucherCode}! Gi√° gi·∫£m: ${formatPrice(originalPrice - discountedPrice)}`);
        })
        .catch(error => {
          console.error('Error applying voucher:', error);
          alert('L·ªói khi √°p d·ª•ng voucher. Vui l√≤ng th·ª≠ l·∫°i!');
        });
    }
    
    // X√≥a voucher ƒë√£ √°p d·ª•ng
    function removeAppliedVoucher() {
      localStorage.removeItem('phuclong_selected_voucher');
      localStorage.removeItem('phuclong_selected_voucher_data');
      
      // Reset gi√° v·ªÅ ban ƒë·∫ßu
      const priceEl = document.getElementById('display-price');
      const discountedEl = document.getElementById('discounted-price');
      const voucherBadge = document.getElementById('voucher-applied-badge');
      
      if (priceEl) {
        priceEl.style.textDecoration = 'none';
        priceEl.style.color = '#fb2e86';
      }
      
      if (discountedEl) {
        discountedEl.style.display = 'none';
      }
      
      if (voucherBadge) {
        voucherBadge.style.display = 'none';
      }
      
      // Reload gi√° t·ª´ product
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      if (productData.price && priceEl) {
        priceEl.textContent = formatPrice(productData.price);
      }
      
      // Reload vouchers ƒë·ªÉ c·∫≠p nh·∫≠t UI
      const product = {
        _id: productData._id || productData.product_id,
        id: productData.id,
        price: productData.price || 0
      };
      if (product._id || product.id) {
        setTimeout(() => {
          loadVouchersForProduct(product);
        }, 100);
      }
    }
    
    // Load recommendations t·ª´ API
    async function loadRecommendations(currentProductSku = null) {
      const recsGrid = document.getElementById('recommendations-grid');
      if (!recsGrid) return;

      try {
        // Load 4 s·∫£n ph·∫©m ng·∫´u nhi√™n (ho·∫∑c c√πng category)
        const response = await fetch('/api/products?pageSize=20');
        const result = await response.json();
        
        if (result.data && result.data.length > 0) {
          // L·ªçc b·ªè s·∫£n ph·∫©m hi·ªán t·∫°i n·∫øu c√≥ v√† lo·∫°i b·ªè tr√πng l·∫∑p
          let products = result.data;
          if (currentProductSku) {
            products = products.filter(p => {
              const pId = String(p.sku || p._id || '');
              const currentId = String(currentProductSku);
              return pId !== currentId;
            });
          }
          
          // Lo·∫°i b·ªè tr√πng l·∫∑p d·ª±a tr√™n SKU ho·∫∑c _id
          const seen = new Set();
          const uniqueProducts = products.filter(p => {
            const id = String(p.sku || p._id || '');
            if (seen.has(id)) {
              return false;
            }
            seen.add(id);
            return true;
          });
          
          // Shuffle ƒë·ªÉ l·∫•y s·∫£n ph·∫©m ng·∫´u nhi√™n
          const shuffled = uniqueProducts.sort(() => Math.random() - 0.5);
          
          // L·∫•y 4 s·∫£n ph·∫©m ng·∫´u nhi√™n (ƒë√£ lo·∫°i b·ªè tr√πng)
          const recommendations = shuffled.slice(0, 4);
          
          if (recommendations.length === 0) {
            recsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #5a5a7a; grid-column: 1 / -1;">Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÅ xu·∫•t</div>';
            return;
          }

          recsGrid.innerHTML = recommendations.map(product => {
            const productId = product.sku || product._id;
            const productName = product.name || 'S·∫£n ph·∫©m';
            
            // L·∫•y gi√° c∆° b·∫£n t·ª´ product.price (kh√¥ng l·∫•y t·ª´ sizes)
            // ƒê·∫£m b·∫£o ch·ªâ hi·ªÉn th·ªã m·ªôt gi√° duy nh·∫•t
            let productPrice = 0;
            if (product.price !== undefined && product.price !== null) {
              productPrice = typeof product.price === 'number' ? product.price : parseFloat(product.price) || 0;
            }
            
            const productImage = (product.images && product.images.length > 0) ? product.images[0] : '/Assets/images/LogoPhucLong.png';
            
            // X·ª≠ l√Ω image path
            let imageSrc = productImage;
            if (!productImage.startsWith('http://') && !productImage.startsWith('https://')) {
              if (productImage.startsWith('/')) {
                imageSrc = productImage;
              } else {
                imageSrc = '/Assets/images/' + productImage;
              }
            }

            return `
              <div class="rec-card" onclick="window.location.href='/ClientSite/product-details.html?sku=${encodeURIComponent(productId)}'">
                <div class="rec-imgwrap">
                  <img src="${imageSrc}" alt="${productName}" onerror="this.src='/Assets/images/LogoPhucLong.png'" />
                  <div class="rec-actions">
                    <button title="Gi·ªè h√†ng" onclick="event.stopPropagation(); addToCartFromRecommendation('${productId}', '${productName.replace(/'/g, "\\'")}', ${productPrice}, '${productImage}');">üõí</button>
                    <button title="Wishlist" onclick="event.stopPropagation();">‚ô°</button>
                    <button title="So s√°nh" onclick="event.stopPropagation();">‚Ü∫</button>
                    <button title="Xem nhanh" onclick="event.stopPropagation(); window.location.href='/ClientSite/product-details.html?sku=${encodeURIComponent(productId)}'">üëÅ</button>
                  </div>
                </div>
                <div class="rec-info">
                  <div class="rec-name">${productName}</div>
                  <div class="rec-rate">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                  <div class="rec-price">${formatPrice(productPrice)}</div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          recsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #5a5a7a; grid-column: 1 / -1;">Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÅ xu·∫•t</div>';
        }
      } catch (error) {
        console.error('Error loading recommendations:', error);
        recsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #5a5a7a; grid-column: 1 / -1;">L·ªói khi t·∫£i s·∫£n ph·∫©m ƒë·ªÅ xu·∫•t</div>';
      }
    }

    // Format price cho recommendations
    function formatPrice(price) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(price);
    }

    // Th√™m v√†o gi·ªè h√†ng t·ª´ recommendations
    async function addToCartFromRecommendation(productId, productName, productPrice, productImage) {
      if (typeof addToCart === 'function') {
        await addToCart(productId, productName, productPrice, productImage);
      } else {
        alert(`ƒê√£ th√™m "${productName}" v√†o gi·ªè h√†ng!`);
      }
    }

    // Load product khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded - Starting loadProductData');
      loadProductData();
    });
    
    // Fallback: ƒê·∫£m b·∫£o loadProductData ƒë∆∞·ª£c g·ªçi sau khi header/footer load
    document.addEventListener('phuclong:hf-loaded', function() {
      console.log('Header/Footer loaded - Ensuring product data is loaded');
      // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ s·∫µn s√†ng
      setTimeout(() => {
        if (document.getElementById('product-name').textContent === 'Loading...') {
          loadProductData();
        }
      }, 100);
    });

    // C·∫≠p nh·∫≠t cart icon khi trang load
    function updateCartIcon() {
      const cart = JSON.parse(localStorage.getItem('phuclong_cart') || '[]');
      const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
      const cartIcon = document.querySelector('.cart-link');
      
      if (cartIcon && totalItems > 0) {
        // X√≥a badge c≈© n·∫øu c√≥
        const existingBadge = cartIcon.querySelector('.cart-badge');
        if (existingBadge) {
          existingBadge.remove();
        }
        
        // Th√™m badge m·ªõi
        const badge = document.createElement('span');
        badge.className = 'cart-badge';
        badge.textContent = totalItems;
        badge.style.cssText = `
          position: absolute;
          top: -5px;
          right: -5px;
          background-color: #fb2e86;
          color: white;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          font-size: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
        `;
        cartIcon.style.position = 'relative';
        cartIcon.appendChild(badge);
      }
    }

    // C·∫≠p nh·∫≠t th√¥ng tin s·∫£n ph·∫©m t·ª´ localStorage
    function updateProductInfo() {
      const productData = JSON.parse(localStorage.getItem('phuclong_current_product') || '{}');
      
      if (productData.id) {
        // C·∫≠p nh·∫≠t t√™n s·∫£n ph·∫©m
        const productName = document.querySelector('.product-name');
        if (productName) {
          productName.textContent = productData.name;
        }
        
        // C·∫≠p nh·∫≠t h√¨nh ·∫£nh
        const productImage = document.querySelector('.product-main-image img');
        if (productImage && productData.image) {
          // X·ª≠ l√Ω image path: n·∫øu ƒë√£ l√† full URL (http/https) th√¨ d√πng tr·ª±c ti·∫øp
          let imageSrc = '';
          const imagePath = productData.image;
          if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
            imageSrc = imagePath;
          } else if (imagePath.startsWith('/')) {
            imageSrc = imagePath;
          } else if (imagePath) {
            imageSrc = `/Assets/images/${imagePath}`;
          } else {
            imageSrc = '/Assets/images/LogoPhucLong.png';
          }
          productImage.src = imageSrc;
          productImage.alt = productData.name;
          productImage.onerror = function() {
            this.src = '/Assets/images/LogoPhucLong.png';
          };
        }
        
        // C·∫≠p nh·∫≠t gi√°
        const priceElements = document.querySelectorAll('.size-price');
        priceElements.forEach(element => {
          element.textContent = `${productData.price.toLocaleString()}‚Ç´`;
        });
        
        console.log('Updated product info:', productData);
      }
    }

    // Kh·ªüi t·∫°o khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      updateLoginStatus();
      updateCartIcon();
      updateProductInfo();
    });
  </script>

  <!-- Footer inject -->
  <div id="site-footer"></div>

  <!-- N·∫°p header/footer -->
  <script
    src="/Assets/Components/layout.js"
    defer
    data-header="/Assets/Components/header.html"
    data-footer="/Assets/Components/footer.html"
    data-header-target="#site-header"
    data-footer-target="#site-footer"
  ></script>
</body>
</html>
